# express
```æœ€åä¸€æ¬¡æ›´æ–°ç¬”è®°æ—¶é—´ï¼š2020-09-23```

![ä¸‰å±‚æ¶æ„](assets/ä¸‰å±‚æ¶æ„.jpg)
### æé—®ï¼šä¸ºä»€ä¹ˆä½¿ç”¨expressï¼Œè€Œä¸ä½¿ç”¨httpæ¨¡å—
1ã€æ ¹æ®ä¸åŒçš„è¯·æ±‚è·¯å¾„ã€è¯·æ±‚æ–¹æ³•ã€åšä¸åŒçš„äº‹æƒ…ï¼Œå¤„ç†èµ·æ¥æ¯”è¾ƒéº»çƒ¦  
2ã€è¯»å–è¯·æ±‚ä½“å’Œå†™å…¥å“åº”ä½“æ˜¯é€šè¿‡æµçš„æ–¹å¼ï¼Œæ¯”è¾ƒéº»çƒ¦
```js
const http =require('http')
http.createServer((req, res) =>{
     // å¤æ‚çš„ä»£ç å¤„ç†è¯·æ±‚
})
```

### ç¬¬ä¸‰æ–¹åº“ 
- express 
  -  ç”Ÿæ€ç¯å¢ƒå®Œæ•´   
  -  æ°‘é—´ä¸­æ–‡ç½‘ï¼šhttps://www.expressjs.com.cn/  
  
- koa2 
  -  åŸºç¡€å…ˆè¿›æ€§å’Œæä¾›çš„APIå‹å¥½æ€§

### åˆ›å»ºä¸€ä¸ªexpressåº”ç”¨
```js
const express = require('express');
const app = express();  // åˆ›å»ºä¸€ä¸ªexpressåº”ç”¨

// appå®é™…ä¸Šæ˜¯ä¸€ä¸ªå‡½æ•°ç”¨äºå¤„ç†è¯·æ±‚çš„å‡½æ•°
const port = 9527;  // ç›‘å¬9527çª—å£
app.listen(port, () => {
    console.log("Listen 9527 server")
})

// é…ç½®ä¸€ä¸ªè¯·æ±‚æ˜ å°„ï¼Œå¦‚æœè¯·æ±‚æ–¹æ³•å’Œè¯·æ±‚çš„è·¯å¾„å‡æ»¡è¶³åŒ¹é…ï¼Œäº¤ç»™å¤„ç†å‡½æ•°è¿›è¡Œå¤„ç†
// app.è¯·æ±‚æ–¹æ³•("è¯·æ±‚è·¯å¾„",å¤„ç†å‡½æ•°)

// åŒ¹é…ä»»ä½•getå¤„ç†è¯·æ±‚
app.get('*', (req, res)=>{
    // req å’Œ res æ˜¯è¢«expresså°è£…è¿‡çš„   
  
    res.send("helloä½†21321æ˜¯åˆ†éƒ½æ˜¯")  // å“åº”ç»™å®¢æˆ·ç«¯
})
```

## nodemon è‡ªåŠ¨é‡å¯å·¥å…·

### å®‰è£…

å‘½ä»¤è¡Œå®‰è£…
``` 
 å±€éƒ¨ï¼š$ yarn add nodemon 
 å…¨å±€ï¼š$ yarn add global nodemon 
```

å±€éƒ¨å®‰è£…è¿è¡Œ
```
$ npx nodemon index.js
$ æˆ–è€…è‡ªè¡Œé…ç½®package.jsonï¼Œæ›´æ”¹å‘½ä»¤
```

å…¨å±€å®‰è£…è¿è¡Œ
```
éœ€è¦é…ç½®ç¯å¢ƒå˜é‡
$nodemon index.js
```
### é…ç½®
```package.json```
```json
{
 "scripts": {
     "start": "npx nodemon index"
  }
}
```
- npm run start

```nodemon.json```
```json
{
  "env": {
    "NODE_ENV": "development"
  },
  "watch": ["*.json", "*.js"],
  "ignore": ["node_modules", ".idea", "yarn.lock", "package*.json"]
}
```
- watch: ç›‘å¬çš„æ–‡ä»¶ç±»å‹
- env: å¯åŠ¨çš„ç¯å¢ƒ
- ignore: å¿½ç•¥çš„æ–‡ä»¶

## express ä¸­é—´ä»¶

![ä¸­é—´ä»¶ç¤ºæ„å›¾](assets/ä¸­é—´ä»¶ç¤ºæ„å›¾.jpg)


### ä¸­é—´ä»¶æ˜¯ä¸€ä¸ªå¤„ç†å‡½æ•°
- å½“åŒ¹é…åˆ°äº†è¯·æ±‚å
  - äº¤ç»™ç¬¬ä¸€ä¸ªå¤„ç†ä¸­é—´ä»¶
  - å¤„ç†ä¸­é—´ä»¶ä¸­éœ€è¦æ‰‹åŠ¨çš„æäº¤ç»™åç»­ä¸­é—´ä»¶å¤„ç†
  - æƒ³è¦è¿è¡Œåç»­çš„å¤„ç†å‡½æ•°ï¼Œéœ€è¦è°ƒç”¨ç¬¬ä¸‰ä¸ªå‚æ•°next()  
    
#### ä¸­é—´ä»¶å¤„ç†çš„ç»†èŠ‚
- å¦‚æœåç»­å·²ç»æ²¡æœ‰äº†ä¸­é—´ä»¶,åˆ¤æ–­æœ‰æ²¡æœ‰è°ƒç”¨res.end() æˆ–è€…res.send()   
  - æ²¡æœ‰è°ƒç”¨ï¼š å‘é€404  
  - è°ƒç”¨ï¼š æ­£å¸¸å“åº”  
```js
app.get("/news",
    (req , res, next) =>{
       console.log("ç¬¬1ä¸ªå¤„ç†ä¸­é—´ä»¶")
       next();  // äº¤ç»™åç»­çš„å¤„ç†ä¸­é—´ä»¶
    },
    (req , res, next) =>{
       console.log("ç¬¬2ä¸ªå¤„ç†ä¸­é—´ä»¶")
       next();  // äº¤ç»™åç»­çš„å¤„ç†ä¸­é—´ä»¶
       // æ²¡æœ‰è°ƒç”¨res.end() å’Œ res.send()  
       // è¿”å› 404
    }
)
```

- å¦‚æœä¸­é—´ä»¶å‘ç”Ÿäº†é”™è¯¯
  - ä¸ä¼šåœæ­¢æœåŠ¡å™¨
  - ç›¸å½“äºè°ƒç”¨äº†next(é”™è¯¯å¯¹è±¡) 
  - å¯»æ‰¾åç»­çš„é”™è¯¯å¤„ç†ä¸­é—´ä»¶ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ç›¸åº”æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ 500ï¼Œ  
 
```js
app.get("/news",
    (req , res, next) =>{
       console.log("ç¬¬1ä¸ªå¤„ç†ä¸­é—´ä»¶")
       next(new Error("è‡ªå·±å†™çš„æŠ¥é”™"));  // äº¤ç»™åç»­çš„é”™è¯¯å¤„ç†ä¸­é—´ä»¶
    },
    (req , res, next) =>{
       console.log("ç¬¬2ä¸ªå¤„ç†ä¸­é—´ä»¶")
       next();                         // äº¤ç»™åç»­çš„å¤„ç†ä¸­é—´ä»¶
    }
    // ...ä¸­é—´ä»¶
)
```

- å½“å‰é¢çš„ä¸­é—´ä»¶ï¼Œè°ƒç”¨res.end()æ—¶  
  - åç»­çš„ä¸­é—´ä»¶è¿˜æ˜¯ä¼šä¾æ¬¡è°ƒç”¨(å¯ä»¥åšæ—¥å¿—è®°å½•)  
  - åç»­çš„ä¸­é—´ä»¶ä¸èƒ½å†æ¬¡è°ƒç”¨res.end()å’Œres.send()ï¼Œä¼šæŠ¥é”™
```js
app.get("/news",
    (req , res, next) =>{
       console.log("ç¬¬1ä¸ªå¤„ç†ä¸­é—´ä»¶")
       res.status(200)   
       res.end();
       next();  // äº¤ç»™åç»­çš„å¤„ç†ä¸­é—´ä»¶
    },
    (req , res, next) =>{
       //ä¼šè¿è¡Œï¼Œå¯ä»¥åšæ—¥å¿—è®°å½•
       console.log("ç¬¬2ä¸ªå¤„ç†ä¸­é—´ä»¶")  
       next();  // äº¤ç»™åç»­çš„å¤„ç†ä¸­é—´ä»¶
    }
    // ...ä¸­é—´ä»¶
)
```

#### å¤„ç†é”™è¯¯çš„ä¸­é—´ä»¶

ä½¿ç”¨```app.use()```æ–¹æ³•
 - app.use,ä¸ç®¡ä»»ä½•å½¢å¼çš„è¯·æ±‚ï¼Œéƒ½ä¼šè°ƒç”¨
 - app.use,é‡‡ç”¨æ¨¡ç³ŠåŒ¹é…è§„åˆ™ï¼Œä¸å’Œapp.get å’Œapp.post ç­‰æ–¹æ³•è¯·æ±‚ä¸€æ ·æ˜¯ç²¾ç¡®åŒ¹é…
```js
// errorMiddleware.js
module.exports = (err, req, res, next) => {
    if (err) {
        // å‘ç”Ÿäº†é”™è¯¯
        const errObj = {
            code: 500,
            msg: err instanceof Error ? err.message : err
        }
        res.status(500).send(errObj)
    }
    else {
        next();
    }
}

// init.js  
// å¤„ç†é”™è¯¯çš„ä¸­é—´ä»¶ï¼Œä¸€èˆ¬æ”¾åˆ°æœ€å
// /news ä¸ºåŸºæœ¬è·¯å¾„ï¼Œ å¯ä»¥åŒ¹é…/newsã€ /newst ã€/news/fd ç­‰æ­£åˆ™åŒ…å«/newsçš„è·¯å¾„ï¼Œä¸èƒ½åŒ¹é…/nç­‰å…¶ä»–è·¯å¾„
app.use('/news',require('./errorMiidewear'))

// æˆ–è€…
// åŒ¹é…ä»»ä½•è·¯å¾„
app.use(require('./errorMiidewear'))
```

#### å¤„ç†é™æ€èµ„æºçš„ä¸­é—´ä»¶
```staticMiddleware.js```
```js
// é™æ€èµ„æº

module.exports = (req, res, next) =>{
    if(req.path.startsWith('/api')){
        // è¯´æ˜ä½ è¯·æ±‚çš„æ˜¯apiæ¥å£
        next()
    }else {
        // åˆ¤æ–­é™æ€èµ„æºæ˜¯å¦å­˜åœ¨

        if(é™æ€èµ„æº){
            res.send("é™æ€èµ„æº")
        }else{
            next();
        }
    }
}
```

## expresså¸¸ç”¨ä¸­é—´ä»¶

#### express.static() 

- é™æ€èµ„æºæœåŠ¡å™¨
- https://www.expressjs.com.cn/5x/api.html#express.static
```js
// dirname ä¸ºé™æ€èµ„æºç›®å½•

/**
 * ä¸‹é¢çš„è¿™æ®µä»£ç çš„ä½œç”¨ï¼š
 * å½“è¯·æ±‚æ—¶ï¼Œä¼šæ ¹æ®è¯·æ±‚è·¯å¾„ï¼Œä»æŒ‡å®šçš„ç›®å½•ä¸­å¯»æ‰¾æ˜¯å¦å­˜åœ¨æ”¹æ–‡ä»¶ï¼Œå¦‚æœå­˜åœ¨ï¼Œç›´æ¥å“åº”æ–‡ä»¶å†…å®¹ï¼Œè€Œä¸å†ç§»äº¤ç»™åç»­çš„ä¸­é—´ä»¶
 * é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœæ˜ å°„çš„ç»“æœæ˜¯ä¸€ä¸ªç›®å½•ï¼Œåˆ™ä¼šè‡ªåŠ¨è¿˜æ˜¯ç”¨idnex.htmlæ–‡ä»¶
 */
app.use(express.static(dirname))

/**
 * ä¸‹é¢çš„ä»£ç ä½œç”¨ï¼š
 * ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºåŸºç¡€è·¯å¾„ï¼Œæ¨¡ç³ŠåŒ¹é… /nextç­‰
 * ç¬¬äºŒä¸ªå‚æ•°ä¸ºé™æ€èµ„æºé™Œè·¯
 */
app.use("/next",express.static(dirname))
```



#### express.urlencoded() 

- è·å–è¯·æ±‚å¤´ï¼ŒåŒ¹é…ç±»å‹ä¸º "application/x-www-form-urlencoded"æ ¼å¼  
- https://www.expressjs.com.cn/5x/api.html#express.urlencoded
```js
app.use(
    express.urlencoded({
            extended: true //ä½¿ç”¨æ–°çš„åº“ï¼Œå¿…é¡»è®¾ç½®
        }
    )
)
```
- æ‰‹å†™
```js
/**
 * æ‰‹å†™ express.urlencoded
 * @param req
 * @param res
 * @param next
 */
const qs = require("querystring")
module.exports = (req, res, next) =>{
    if((req.headers["content-type"]) === "application/x-www-form-urlencoded"){
        // è‡ªè¡Œè§£ææ¶ˆæ¯ä½“
        let result = "";
        req.on("data", chunk =>{
            result += chunk.toString("utf-8")
        });
        req.on("end", ()=>{
            // æŠŠresultè§£ææˆä¸€ä¸ªå¯¹è±¡ï¼Œç„¶åæ”¾åˆ°req.body 
            req.body = qs.parse(result);
            next();
        })
    }else{
        next();
    }

}
```


#### express.json()

- https://www.expressjs.com.cn/5x/api.html#express.json
- è§£æJSONæ ¼å¼çš„æ¶ˆæ¯ä½“
```js
app.use(express.json())
```

## expressè·¯ç”±

#### express.router()

- https://www.expressjs.com.cn/5x/api.html#express.router
```js
// routes/init.js 
// å¤„ç†api çš„è¯·æ±‚
app.use('/api/student', require('./api/student'));

// routes/api/student.js
// è®¾ç½®è·¯ç”±
const express = require('express')
const router = express.Router();

// get -> /api/student
router.get('/', async (req, res) => {
    console.log("è·å–å­¦ç”Ÿ")
    const info = {
        page:req.query.page || 1,
        limit: req.query.limit || 10,
        sex: req.query.sex || -1,
        name: req.query.name || ""
    }
    const data = await studentServ.getStudent(info);
    
    // ä¸¾ä¸ªä¾‹å­ï¼Œå¯ä»¥è‡ªå·±å°è£…
    res.send({
        code: 0,
        msg: "",
        data
    })
});
// get -> /api/student/xxx
router.get('/:id', (req, res) => {
    console.log("è·å–å•ä¸ªå­¦ç”Ÿ")
});

// post -> /api/student
router.post('/', (req, res) => {
    console.log("æ·»åŠ å­¦ç”Ÿ")
});

// delete ->/api/student:id
router.delete('/:id', (req, res) => {
    console.log('åˆ é™¤å­¦ç”Ÿ')
})

// put -> /api/student/xxx
router.put("/:id", (req, res) => {
    console.log("ä¿®æ”¹å­¦ç”Ÿ")
})

module.exports = router
```

## cookieçš„åŸºæœ¬æ¦‚å¿µ
### ä¸€ä¸ªä¸å¤§ä¸å°çš„é—®é¢˜

å‡è®¾æœåŠ¡å™¨æœ‰ä¸€ä¸ªæ¥å£ï¼Œé€šè¿‡è¯·æ±‚è¿™ä¸ªæ¥å£ï¼Œå¯ä»¥æ·»åŠ ä¸€ä¸ªç®¡ç†å‘˜

ä½†æ˜¯ï¼Œä¸æ˜¯ä»»ä½•äººéƒ½æœ‰æƒåŠ›åšè¿™ç§æ“ä½œçš„

é‚£ä¹ˆæœåŠ¡å™¨å¦‚ä½•çŸ¥é“è¯·æ±‚æ¥å£çš„äººæ˜¯æœ‰æƒåŠ›çš„å‘¢ï¼Ÿ

ç­”æ¡ˆæ˜¯ï¼šåªæœ‰ç™»å½•è¿‡çš„ç®¡ç†å‘˜æ‰èƒ½åšè¿™ç§æ“ä½œ

å¯é—®é¢˜æ˜¯ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„ä¼ è¾“ä½¿ç”¨çš„æ˜¯httpåè®®ï¼Œhttpåè®®æ˜¯æ— çŠ¶æ€çš„ï¼Œä»€ä¹ˆå«æ— çŠ¶æ€ï¼Œå°±æ˜¯**æœåŠ¡å™¨ä¸çŸ¥é“è¿™ä¸€æ¬¡è¯·æ±‚çš„äººï¼Œè·Ÿä¹‹å‰ç™»å½•è¯·æ±‚æˆåŠŸçš„äººæ˜¯ä¸æ˜¯åŒä¸€ä¸ªäºº**

![](assets/cookie1.png)

![](assets/cookie2.png)

ç”±äºhttpåè®®çš„æ— çŠ¶æ€ï¼ŒæœåŠ¡å™¨**å¿˜è®°**äº†ä¹‹å‰çš„æ‰€æœ‰è¯·æ±‚ï¼Œå®ƒæ— æ³•ç¡®å®šè¿™ä¸€æ¬¡è¯·æ±‚çš„å®¢æˆ·ç«¯ï¼Œå°±æ˜¯ä¹‹å‰ç™»å½•æˆåŠŸçš„é‚£ä¸ªå®¢æˆ·ç«¯ã€‚

> ä½ å¯ä»¥æŠŠæœåŠ¡å™¨æƒ³è±¡æˆæœ‰ç€ä¸¥é‡è„¸ç›²ç—‡çš„ä¸œå“¥ï¼Œä»–æ²¡æœ‰åŠæ³•åˆ†æ¸…æ¥šè·Ÿä»–è¯´è¯çš„äººä¹‹å‰åšè¿‡ä»€ä¹ˆ

äºæ˜¯ï¼ŒæœåŠ¡å™¨æƒ³äº†ä¸€ä¸ªåŠæ³•

å®ƒæŒ‰ç…§ä¸‹é¢çš„æµç¨‹æ¥è®¤è¯å®¢æˆ·ç«¯çš„èº«ä»½

1. å®¢æˆ·ç«¯ç™»å½•æˆåŠŸåï¼ŒæœåŠ¡å™¨ä¼šç»™å®¢æˆ·ç«¯ä¸€ä¸ªå‡ºå…¥è¯ï¼ˆä»¤ç‰Œ tokenï¼‰
2. åç»­å®¢æˆ·ç«¯çš„æ¯æ¬¡è¯·æ±‚ï¼Œéƒ½å¿…é¡»è¦é™„å¸¦è¿™ä¸ªå‡ºå…¥è¯ï¼ˆä»¤ç‰Œ tokenï¼‰

![ä¿®é¥°](assets/cookie3.png)

æœåŠ¡å™¨å‘æ‰¬äº†è®¤è¯ä¸è®¤äººçš„ä¼˜è‰¯ä¼ ç»Ÿï¼Œå°±å¯ä»¥å¾ˆè½»æ¾çš„è¯†åˆ«èº«ä»½äº†ã€‚

ä½†æ˜¯ï¼Œç”¨æˆ·ä¸å¯èƒ½åªåœ¨ä¸€ä¸ªç½‘ç«™ç™»å½•ï¼Œäºæ˜¯å®¢æˆ·ç«¯ä¼šæ”¶åˆ°æ¥è‡ªå„ä¸ªç½‘ç«™çš„å‡ºå…¥è¯ï¼Œå› æ­¤ï¼Œå°±è¦æ±‚å®¢æˆ·ç«¯è¦æœ‰ä¸€ä¸ªç±»ä¼¼äºå¡åŒ…çš„ä¸œè¥¿ï¼Œèƒ½å¤Ÿå…·å¤‡ä¸‹é¢çš„åŠŸèƒ½ï¼š

1. **èƒ½å¤Ÿå­˜æ”¾å¤šä¸ªå‡ºå…¥è¯**ã€‚è¿™äº›å‡ºå…¥è¯æ¥è‡ªä¸åŒçš„ç½‘ç«™ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªç½‘ç«™æœ‰å¤šä¸ªå‡ºå…¥è¯ï¼Œåˆ†åˆ«ç”¨äºå‡ºå…¥ä¸åŒçš„åœ°æ–¹
2. **èƒ½å¤Ÿè‡ªåŠ¨å‡ºç¤ºå‡ºå…¥è¯**ã€‚å®¢æˆ·ç«¯åœ¨è®¿é—®ä¸åŒçš„ç½‘ç«™æ—¶ï¼Œèƒ½å¤Ÿè‡ªåŠ¨çš„æŠŠå¯¹åº”çš„å‡ºå…¥è¯é™„å¸¦è¯·æ±‚å‘é€å‡ºå»ã€‚
3. **æ­£ç¡®çš„å‡ºç¤ºå‡ºå…¥è¯**ã€‚å®¢æˆ·ç«¯ä¸èƒ½å°†è‚¯å¾·åŸºçš„å‡ºå…¥è¯å‘é€ç»™éº¦å½“åŠ³ã€‚
4. **ç®¡ç†å‡ºå…¥è¯çš„æœ‰æ•ˆæœŸ**ã€‚å®¢æˆ·ç«¯è¦èƒ½å¤Ÿè‡ªåŠ¨çš„å‘ç°é‚£äº›å·²ç»è¿‡æœŸçš„å‡ºå…¥è¯ï¼Œå¹¶æŠŠå®ƒä»å¡åŒ…å†…ç§»é™¤ã€‚

èƒ½å¤Ÿæ»¡è¶³ä¸Šé¢æ‰€æœ‰è¦æ±‚çš„ï¼Œå°±æ˜¯cookie

cookieç±»ä¼¼äºä¸€ä¸ªå¡åŒ…ï¼Œä¸“é—¨ç”¨äºå­˜æ”¾å„ç§å‡ºå…¥è¯ï¼Œå¹¶æœ‰ç€ä¸€å¥—æœºåˆ¶æ¥è‡ªåŠ¨ç®¡ç†è¿™äº›è¯ä»¶ã€‚

å¡åŒ…å†…çš„æ¯ä¸€å¼ å¡ç‰‡ï¼Œç§°ä¹‹ä¸º**ä¸€ä¸ªcookie**ã€‚

### cookieçš„ç»„æˆ

cookieæ˜¯æµè§ˆå™¨ä¸­ç‰¹æœ‰çš„ä¸€ä¸ªæ¦‚å¿µï¼Œå®ƒå°±åƒæµè§ˆå™¨çš„ä¸“å±å¡åŒ…ï¼Œç®¡ç†ç€å„ä¸ªç½‘ç«™çš„èº«ä»½ä¿¡æ¯ã€‚

æ¯ä¸ªcookieå°±ç›¸å½“äºæ˜¯å±äºæŸä¸ªç½‘ç«™çš„ä¸€ä¸ªå¡ç‰‡ï¼Œå®ƒè®°å½•äº†ä¸‹é¢çš„ä¿¡æ¯ï¼š

- keyï¼šé”®ï¼Œæ¯”å¦‚ã€Œèº«ä»½ç¼–å·ã€
- valueï¼šå€¼ï¼Œæ¯”å¦‚è¢å°è¿›çš„èº«ä»½ç¼–å·ã€Œ14563D1550F2F76D69ECBF4DD54ABC95ã€ï¼Œè¿™æœ‰ç‚¹åƒå¡ç‰‡çš„æ¡å½¢ç ï¼Œå½“ç„¶ï¼Œå®ƒå¯ä»¥æ˜¯ä»»ä½•ä¿¡æ¯
- domainï¼šåŸŸï¼Œè¡¨è¾¾è¿™ä¸ªcookieæ˜¯å±äºå“ªä¸ªç½‘ç«™çš„ï¼Œæ¯”å¦‚`yuanjin.tech`ï¼Œè¡¨ç¤ºè¿™ä¸ªcookieæ˜¯å±äº`yuanjin.tech`è¿™ä¸ªç½‘ç«™çš„
- pathï¼šè·¯å¾„ï¼Œè¡¨è¾¾è¿™ä¸ªcookieæ˜¯å±äºè¯¥ç½‘ç«™çš„å“ªä¸ªåŸºè·¯å¾„çš„ï¼Œå°±å¥½æ¯”æ˜¯åŒä¸€å®¶å…¬å¸ä¸åŒéƒ¨é—¨ä¼šé¢å‘ä¸åŒçš„å‡ºå…¥è¯ã€‚æ¯”å¦‚`/news`ï¼Œè¡¨ç¤ºè¿™ä¸ªcookieå±äº`/news`è¿™ä¸ªè·¯å¾„çš„ã€‚ï¼ˆåç»­è¯¦ç»†è§£é‡Šï¼‰
- secureï¼šæ˜¯å¦ä½¿ç”¨å®‰å…¨ä¼ è¾“ï¼ˆåç»­è¯¦ç»†è§£é‡Šï¼‰
- expireï¼šè¿‡æœŸæ—¶é—´ï¼Œè¡¨ç¤ºè¯¥cookieåœ¨ä»€ä¹ˆæ—¶å€™è¿‡æœŸ

å½“æµè§ˆå™¨å‘æœåŠ¡å™¨å‘é€ä¸€ä¸ªè¯·æ±‚çš„æ—¶å€™ï¼Œå®ƒä¼šç„ä¸€çœ¼è‡ªå·±çš„å¡åŒ…ï¼Œçœ‹çœ‹å“ªäº›å¡ç‰‡é€‚åˆé™„å¸¦æç»™æœåŠ¡å™¨

å¦‚æœä¸€ä¸ªcookie**åŒæ—¶æ»¡è¶³**ä»¥ä¸‹æ¡ä»¶ï¼Œåˆ™è¿™ä¸ªcookieä¼šè¢«é™„å¸¦åˆ°è¯·æ±‚ä¸­

- cookieæ²¡æœ‰è¿‡æœŸ
- cookieä¸­çš„åŸŸå’Œè¿™æ¬¡è¯·æ±‚çš„åŸŸæ˜¯åŒ¹é…çš„
  - æ¯”å¦‚cookieä¸­çš„åŸŸæ˜¯`yuanjin.tech`ï¼Œåˆ™å¯ä»¥åŒ¹é…çš„è¯·æ±‚åŸŸæ˜¯`yuanjin.tech`ã€`www.yuanjin.tech`ã€`blogs.yuanjin.tech`ç­‰ç­‰
  - æ¯”å¦‚cookieä¸­çš„åŸŸæ˜¯`www.yuanjin.tech`ï¼Œåˆ™åªèƒ½åŒ¹é…`www.yuanjin.tech`è¿™æ ·çš„è¯·æ±‚åŸŸ
  - cookieæ˜¯ä¸åœ¨ä¹ç«¯å£çš„ï¼Œåªè¦åŸŸåŒ¹é…å³å¯
- cookieä¸­çš„pathå’Œè¿™æ¬¡è¯·æ±‚çš„pathæ˜¯åŒ¹é…çš„
  - æ¯”å¦‚cookieä¸­çš„pathæ˜¯`/news`ï¼Œåˆ™å¯ä»¥åŒ¹é…çš„è¯·æ±‚è·¯å¾„å¯ä»¥æ˜¯`/news`ã€`/news/detail`ã€`/news/a/b/c`ç­‰ç­‰ï¼Œä½†ä¸èƒ½åŒ¹é…`/blogs`
  - å¦‚æœcookieçš„pathæ˜¯`/`ï¼Œå¯ä»¥æƒ³è±¡ï¼Œèƒ½å¤ŸåŒ¹é…æ‰€æœ‰çš„è·¯å¾„
- éªŒè¯cookieçš„å®‰å…¨ä¼ è¾“
  - å¦‚æœcookieçš„secureå±æ€§æ˜¯trueï¼Œåˆ™è¯·æ±‚åè®®å¿…é¡»æ˜¯`https`ï¼Œå¦åˆ™ä¸ä¼šå‘é€è¯¥cookie
  - å¦‚æœcookieçš„secureå±æ€§æ˜¯falseï¼Œåˆ™è¯·æ±‚åè®®å¯ä»¥æ˜¯`http`ï¼Œä¹Ÿå¯ä»¥æ˜¯`https`

å¦‚æœä¸€ä¸ªcookieæ»¡è¶³äº†ä¸Šè¿°çš„æ‰€æœ‰æ¡ä»¶ï¼Œåˆ™æµè§ˆå™¨ä¼šæŠŠå®ƒè‡ªåŠ¨åŠ å…¥åˆ°è¿™æ¬¡è¯·æ±‚ä¸­

å…·ä½“åŠ å…¥çš„æ–¹å¼æ˜¯ï¼Œ**æµè§ˆå™¨ä¼šå°†ç¬¦åˆæ¡ä»¶çš„cookieï¼Œè‡ªåŠ¨æ”¾ç½®åˆ°è¯·æ±‚å¤´ä¸­**ï¼Œä¾‹å¦‚ï¼Œå½“æˆ‘åœ¨æµè§ˆå™¨ä¸­è®¿é—®ç™¾åº¦çš„æ—¶å€™ï¼Œå®ƒåœ¨è¯·æ±‚å¤´ä¸­é™„å¸¦äº†ä¸‹é¢çš„cookieï¼š

![](assets/4.png)

çœ‹åˆ°æ‰“é©¬èµ›å…‹çš„åœ°æ–¹äº†å—ï¼Ÿè¿™éƒ¨åˆ†å°±æ˜¯é€šè¿‡è¯·æ±‚å¤´`cookie`å‘é€åˆ°æœåŠ¡å™¨çš„ï¼Œå®ƒçš„æ ¼å¼æ˜¯`é”®=å€¼; é”®=å€¼; é”®=å€¼; ...`ï¼Œæ¯ä¸€ä¸ªé”®å€¼å¯¹å°±æ˜¯ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„cookieã€‚

**cookieä¸­åŒ…å«äº†é‡è¦çš„èº«ä»½ä¿¡æ¯ï¼Œæ°¸è¿œä¸è¦æŠŠä½ çš„cookieæ³„éœ²ç»™åˆ«äººï¼ï¼ï¼**å¦åˆ™ï¼Œä»–äººå°±æ‹¿åˆ°äº†ä½ çš„è¯ä»¶ï¼Œæœ‰äº†è¯ä»¶ï¼Œå°±å…·å¤‡äº†ä¸ºæ‰€æ¬²ä¸ºçš„å¯èƒ½æ€§ã€‚

### å¦‚ä½•è®¾ç½®cookie

ç”±äºcookieæ˜¯ä¿å­˜åœ¨æµè§ˆå™¨ç«¯çš„ï¼ŒåŒæ—¶ï¼Œå¾ˆå¤šè¯ä»¶åˆæ˜¯æœåŠ¡å™¨é¢å‘çš„

æ‰€ä»¥ï¼Œcookieçš„è®¾ç½®æœ‰ä¸¤ç§æ¨¡å¼ï¼š

- æœåŠ¡å™¨å“åº”ï¼šè¿™ç§æ¨¡å¼æ˜¯éå¸¸æ™®éçš„ï¼Œå½“æœåŠ¡å™¨å†³å®šç»™å®¢æˆ·ç«¯é¢å‘ä¸€ä¸ªè¯ä»¶æ—¶ï¼Œå®ƒä¼šåœ¨å“åº”çš„æ¶ˆæ¯ä¸­åŒ…å«cookieï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨çš„æŠŠcookieä¿å­˜åˆ°å¡åŒ…ä¸­
- å®¢æˆ·ç«¯è‡ªè¡Œè®¾ç½®ï¼šè¿™ç§æ¨¡å¼å°‘è§ä¸€äº›ï¼Œä¸è¿‡ä¹Ÿæœ‰å¯èƒ½ä¼šå‘ç”Ÿï¼Œæ¯”å¦‚ç”¨æˆ·å…³é—­äº†æŸä¸ªå¹¿å‘Šï¼Œå¹¶é€‰æ‹©äº†ã€Œä»¥åä¸è¦å†å¼¹å‡ºã€ï¼Œæ­¤æ—¶å°±å¯ä»¥æŠŠè¿™ç§å°ä¿¡æ¯ç›´æ¥é€šè¿‡æµè§ˆå™¨çš„JSä»£ç ä¿å­˜åˆ°cookieä¸­ã€‚åç»­è¯·æ±‚æœåŠ¡å™¨æ—¶ï¼ŒæœåŠ¡å™¨ä¼šçœ‹åˆ°å®¢æˆ·ç«¯ä¸æƒ³è¦å†æ¬¡å¼¹å‡ºå¹¿å‘Šçš„cookieï¼Œäºæ˜¯å°±ä¸ä¼šå†å‘é€å¹¿å‘Šè¿‡æ¥äº†ã€‚

#### æœåŠ¡å™¨ç«¯è®¾ç½®cookie

æœåŠ¡å™¨å¯ä»¥é€šè¿‡è®¾ç½®å“åº”å¤´ï¼Œæ¥å‘Šè¯‰æµè§ˆå™¨åº”è¯¥å¦‚ä½•è®¾ç½®cookie

å“åº”å¤´æŒ‰ç…§ä¸‹é¢çš„æ ¼å¼è®¾ç½®ï¼š

```js
// set-cookis: cookie 
res.header('set-cookie', "cookie1")  
res.header('set-cookie', "cookie2")  
res.header('set-cookie', "cookie3")  
```

é€šè¿‡è¿™ç§æ¨¡å¼ï¼Œå°±å¯ä»¥åœ¨ä¸€æ¬¡å“åº”ä¸­è®¾ç½®å¤šä¸ªcookieäº†ï¼Œå…·ä½“è®¾ç½®å¤šå°‘ä¸ªcookieï¼Œè®¾ç½®ä»€ä¹ˆcookieï¼Œæ ¹æ®ä½ çš„éœ€è¦è‡ªè¡Œå¤„ç†

å…¶ä¸­ï¼Œæ¯ä¸ªcookieçš„æ ¼å¼å¦‚ä¸‹ï¼š

```
é”®=å€¼; path=?; domain=?; expire=?; max-age=?; secure; httponly
```

æ¯ä¸ªcookieé™¤äº†é”®å€¼å¯¹æ˜¯å¿…é¡»è¦è®¾ç½®çš„ï¼Œå…¶ä»–çš„å±æ€§éƒ½æ˜¯å¯é€‰çš„ï¼Œå¹¶ä¸”é¡ºåºä¸é™

å½“è¿™æ ·çš„å“åº”å¤´åˆ°è¾¾å®¢æˆ·ç«¯åï¼Œ**æµè§ˆå™¨ä¼šè‡ªåŠ¨çš„å°†cookieä¿å­˜åˆ°å¡åŒ…ä¸­ï¼Œå¦‚æœå¡åŒ…ä¸­å·²ç»å­˜åœ¨ä¸€æ¨¡ä¸€æ ·çš„å¡ç‰‡ï¼ˆå…¶ä»–keyã€pathã€domainç›¸åŒï¼‰ï¼Œåˆ™ä¼šè‡ªåŠ¨çš„è¦†ç›–ä¹‹å‰çš„è®¾ç½®**ã€‚

ä¸‹é¢ï¼Œä¾æ¬¡è¯´æ˜æ¯ä¸ªå±æ€§å€¼ï¼š

- **path**ï¼šè®¾ç½®cookieçš„è·¯å¾„ã€‚å¦‚æœä¸è®¾ç½®ï¼Œæµè§ˆå™¨ä¼šå°†å…¶è‡ªåŠ¨è®¾ç½®ä¸ºå½“å‰è¯·æ±‚çš„è·¯å¾„ã€‚æ¯”å¦‚ï¼Œæµè§ˆå™¨è¯·æ±‚çš„åœ°å€æ˜¯`/login`ï¼ŒæœåŠ¡å™¨å“åº”äº†ä¸€ä¸ª`set-cookie: a=1`ï¼Œæµè§ˆå™¨ä¼šå°†è¯¥cookieçš„pathè®¾ç½®ä¸ºè¯·æ±‚çš„è·¯å¾„`/login`
- **domain**ï¼šè®¾ç½®cookieçš„åŸŸã€‚å¦‚æœä¸è®¾ç½®ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨å°†å…¶è®¾ç½®ä¸ºå½“å‰çš„è¯·æ±‚åŸŸï¼Œæ¯”å¦‚ï¼Œæµè§ˆå™¨è¯·æ±‚çš„åœ°å€æ˜¯`http://www.yuanjin.tech`ï¼ŒæœåŠ¡å™¨å“åº”äº†ä¸€ä¸ª`set-cookie: a=1`ï¼Œæµè§ˆå™¨ä¼šå°†è¯¥cookieçš„domainè®¾ç½®ä¸ºè¯·æ±‚çš„åŸŸ`www.yuanjin.tech`
  - è¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæœåŠ¡å™¨å“åº”äº†ä¸€ä¸ªæ— æ•ˆçš„åŸŸï¼Œæµè§ˆå™¨æ˜¯ä¸è®¤çš„
  - ä»€ä¹ˆæ˜¯æ— æ•ˆçš„åŸŸï¼Ÿå°±æ˜¯å“åº”çš„åŸŸè¿æ ¹åŸŸéƒ½ä¸ä¸€æ ·ã€‚æ¯”å¦‚ï¼Œæµè§ˆå™¨è¯·æ±‚çš„åŸŸæ˜¯`yuanjin.tech`ï¼ŒæœåŠ¡å™¨å“åº”çš„cookieæ˜¯`set-cookie: a=1; domain=baidu.com`ï¼Œè¿™æ ·çš„åŸŸæµè§ˆå™¨æ˜¯ä¸è®¤çš„ã€‚
  - å¦‚æœæµè§ˆå™¨è¿è¿™æ ·çš„æƒ…å†µéƒ½å…è®¸ï¼Œå°±æ„å‘³ç€å¼ ä¸‰çš„æœåŠ¡å™¨ï¼Œæœ‰æƒåˆ©ç»™ç”¨æˆ·ä¸€ä¸ªcookieï¼Œç”¨äºè®¿é—®æå››çš„æœåŠ¡å™¨ï¼Œè¿™ä¼šé€ æˆå¾ˆå¤šå®‰å…¨æ€§çš„é—®é¢˜
- **expire**ï¼šè®¾ç½®cookieçš„è¿‡æœŸæ—¶é—´ã€‚è¿™é‡Œå¿…é¡»æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„GMTæ—¶é—´ï¼Œå³æ ¼æ—å¨æ²»æ ‡å‡†æ—¶é—´å­—ç¬¦ä¸²ï¼Œæ¯”å¦‚`Fri, 17 Apr 2020 09:35:59 GMT`ï¼Œè¡¨ç¤ºæ ¼æ—å¨æ²»æ—¶é—´çš„`2020-04-17 09:35:59`ï¼Œå³åŒ—äº¬æ—¶é—´çš„`2020-04-17 17:35:59`ã€‚å½“å®¢æˆ·ç«¯çš„æ—¶é—´è¾¾åˆ°è¿™ä¸ªæ—¶é—´ç‚¹åï¼Œä¼šè‡ªåŠ¨é”€æ¯è¯¥cookieã€‚
- **max-age**ï¼šè®¾ç½®cookieçš„ç›¸å¯¹æœ‰æ•ˆæœŸã€‚expireå’Œmax-ageé€šå¸¸ä»…è®¾ç½®ä¸€ä¸ªå³å¯ã€‚æ¯”å¦‚è®¾ç½®`max-age`ä¸º`1000`ï¼Œæµè§ˆå™¨åœ¨æ·»åŠ cookieæ—¶ï¼Œä¼šè‡ªåŠ¨è®¾ç½®å®ƒçš„`expire`ä¸ºå½“å‰æ—¶é—´åŠ ä¸Š1000ç§’ï¼Œä½œä¸ºè¿‡æœŸæ—¶é—´ã€‚
  - å¦‚æœä¸è®¾ç½®expireï¼Œåˆæ²¡æœ‰è®¾ç½®max-ageï¼Œåˆ™è¡¨ç¤ºä¼šè¯ç»“æŸåè¿‡æœŸã€‚
  - å¯¹äºå¤§éƒ¨åˆ†æµè§ˆå™¨è€Œè¨€ï¼Œå…³é—­æ‰€æœ‰æµè§ˆå™¨çª—å£æ„å‘³ç€ä¼šè¯ç»“æŸã€‚
- **secure**ï¼šè®¾ç½®cookieæ˜¯å¦æ˜¯å®‰å…¨è¿æ¥ã€‚å¦‚æœè®¾ç½®äº†è¯¥å€¼ï¼Œåˆ™è¡¨ç¤ºè¯¥cookieåç»­åªèƒ½éšç€`https`è¯·æ±‚å‘é€ã€‚å¦‚æœä¸è®¾ç½®ï¼Œåˆ™è¡¨ç¤ºè¯¥cookieä¼šéšç€æ‰€æœ‰è¯·æ±‚å‘é€ã€‚
- **httponly**ï¼šè®¾ç½®cookieæ˜¯å¦ä»…èƒ½ç”¨äºä¼ è¾“ã€‚å¦‚æœè®¾ç½®äº†è¯¥å€¼ï¼Œè¡¨ç¤ºè¯¥cookieä»…èƒ½ç”¨äºä¼ è¾“ï¼Œè€Œä¸å…è®¸åœ¨å®¢æˆ·ç«¯é€šè¿‡JSè·å–ï¼Œè¿™å¯¹é˜²æ­¢è·¨ç«™è„šæœ¬æ”»å‡»ï¼ˆXSSï¼‰ä¼šå¾ˆæœ‰ç”¨ã€‚ 
  - å…³äºå¦‚ä½•é€šè¿‡JSè·å–ï¼Œåç»­ä¼šè®²è§£
  - å…³äºä»€ä¹ˆæ˜¯XSSï¼Œä¸åœ¨æœ¬æ–‡è®¨è®ºèŒƒå›´

ä¸‹é¢æ¥ä¸€ä¸ªä¾‹å­ï¼Œå®¢æˆ·ç«¯é€šè¿‡`post`è¯·æ±‚æœåŠ¡å™¨`http://yuanjin.tech/login`ï¼Œå¹¶åœ¨æ¶ˆæ¯ä½“ä¸­ç»™äºˆäº†è´¦å·å’Œå¯†ç ï¼ŒæœåŠ¡å™¨éªŒè¯ç™»å½•æˆåŠŸåï¼Œåœ¨å“åº”å¤´ä¸­åŠ å…¥äº†ä»¥ä¸‹å†…å®¹ï¼š

```yaml
res.header('set-cookie': 'token=123456; path=/; max-age=3600; httponly')
// set-cookie: token=123456; path=/; max-age=3600; httponly
```

å½“è¯¥å“åº”åˆ°è¾¾æµè§ˆå™¨åï¼Œæµè§ˆå™¨ä¼šåˆ›å»ºä¸‹é¢çš„cookieï¼š

```yaml
key: token
value: 123456
domain: yuanjin.tech
path: /
expire: 2020-04-17 18:55:00 #å‡è®¾å½“å‰æ—¶é—´æ˜¯2020-04-17 17:55:00
secure: false  #ä»»ä½•è¯·æ±‚éƒ½å¯ä»¥é™„å¸¦è¿™ä¸ªcookieï¼Œåªè¦æ»¡è¶³å…¶ä»–è¦æ±‚
httponly: true #ä¸å…è®¸JSè·å–è¯¥cookie
```

äºæ˜¯ï¼Œéšç€æµè§ˆå™¨åç»­å¯¹æœåŠ¡å™¨çš„è¯·æ±‚ï¼Œåªè¦æ»¡è¶³è¦æ±‚ï¼Œè¿™ä¸ªcookieå°±ä¼šè¢«é™„å¸¦åˆ°è¯·æ±‚å¤´ä¸­ä¼ ç»™æœåŠ¡å™¨ï¼š

```yaml
cookie: token=123456; å…¶ä»–cookie...
```

ç°åœ¨ï¼Œè¿˜å‰©ä¸‹æœ€åä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¦‚ä½•åˆ é™¤æµè§ˆå™¨çš„ä¸€ä¸ªcookieå‘¢ï¼Ÿ

å¦‚æœè¦åˆ é™¤æµè§ˆå™¨çš„cookieï¼Œåªéœ€è¦è®©æœåŠ¡å™¨å“åº”ä¸€ä¸ªåŒæ ·çš„åŸŸã€åŒæ ·çš„è·¯å¾„ã€åŒæ ·çš„keyï¼Œåªæ˜¯æ—¶é—´è¿‡æœŸçš„cookieå³å¯

**æ‰€ä»¥ï¼Œåˆ é™¤cookieå…¶å®å°±æ˜¯ä¿®æ”¹cookie**

ä¸‹é¢çš„å“åº”ä¼šè®©æµè§ˆå™¨åˆ é™¤`token`

```yaml
cookie: token=; domain=yuanjin.tech; path=/; max-age=-1
```

æµè§ˆå™¨æŒ‰ç…§è¦æ±‚ä¿®æ”¹äº†cookieåï¼Œä¼šå‘ç°cookieå·²ç»è¿‡æœŸï¼Œäºæ˜¯è‡ªç„¶å°±ä¼šåˆ é™¤äº†ã€‚

> æ— è®ºæ˜¯ä¿®æ”¹è¿˜æ˜¯åˆ é™¤ï¼Œéƒ½è¦æ³¨æ„cookieçš„åŸŸå’Œè·¯å¾„ï¼Œå› ä¸ºå®Œå…¨å¯èƒ½å­˜åœ¨åŸŸæˆ–è·¯å¾„ä¸åŒï¼Œä½†keyç›¸åŒçš„cookie
>
> å› æ­¤æ— æ³•ä»…é€šè¿‡keyç¡®å®šæ˜¯å“ªä¸€ä¸ªcookie

#### å®¢æˆ·ç«¯è®¾ç½®cookie

æ—¢ç„¶cookieæ˜¯å­˜æ”¾åœ¨æµè§ˆå™¨ç«¯çš„ï¼Œæ‰€ä»¥æµè§ˆå™¨å‘JSå…¬å¼€äº†æ¥å£ï¼Œè®©å…¶å¯ä»¥è®¾ç½®cookie

```js
document.cookie = "é”®=å€¼; path=?; domain=?; expire=?; max-age=?; secure";
```

å¯ä»¥çœ‹å‡ºï¼Œåœ¨å®¢æˆ·ç«¯è®¾ç½®cookieï¼Œå’ŒæœåŠ¡å™¨è®¾ç½®cookieçš„æ ¼å¼ä¸€æ ·ï¼Œåªæ˜¯æœ‰ä¸‹é¢çš„ä¸åŒ

- æ²¡æœ‰httponlyã€‚å› ä¸ºhttponlyæœ¬æ¥å°±æ˜¯ä¸ºäº†é™åˆ¶åœ¨å®¢æˆ·ç«¯è®¿é—®çš„ï¼Œæ—¢ç„¶ä½ æ˜¯åœ¨å®¢æˆ·ç«¯é…ç½®ï¼Œè‡ªç„¶å¤±å»äº†é™åˆ¶çš„æ„ä¹‰ã€‚
- pathçš„é»˜è®¤å€¼ã€‚åœ¨æœåŠ¡å™¨ç«¯è®¾ç½®cookieæ—¶ï¼Œå¦‚æœæ²¡æœ‰å†™pathï¼Œä½¿ç”¨çš„æ˜¯è¯·æ±‚çš„pathã€‚è€Œåœ¨å®¢æˆ·ç«¯è®¾ç½®cookieæ—¶ï¼Œä¹Ÿè®¸æ ¹æœ¬æ²¡æœ‰è¯·æ±‚å‘ç”Ÿã€‚å› æ­¤ï¼Œpathåœ¨å®¢æˆ·ç«¯è®¾ç½®æ—¶çš„é»˜è®¤å€¼æ˜¯å½“å‰ç½‘é¡µçš„path
- domainçš„é»˜è®¤å€¼ã€‚å’ŒpathåŒç†ï¼Œå®¢æˆ·ç«¯è®¾ç½®æ—¶çš„é»˜è®¤å€¼æ˜¯å½“å‰ç½‘é¡µçš„domain
- å…¶ä»–ï¼šä¸€æ ·
- åˆ é™¤cookieï¼šå’ŒæœåŠ¡å™¨ä¹Ÿä¸€æ ·ï¼Œä¿®æ”¹cookieçš„è¿‡æœŸæ—¶é—´å³å¯

### æ€»ç»“

ä»¥ä¸Šï¼Œå°±æ˜¯cookieåŸç†éƒ¨åˆ†çš„å†…å®¹ã€‚

å¦‚æœæŠŠå®ƒç”¨äºç™»å½•åœºæ™¯ï¼Œå°±æ˜¯å¦‚ä¸‹çš„æµç¨‹ï¼š

**ç™»å½•è¯·æ±‚**

1. æµè§ˆå™¨å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨ï¼Œé™„å¸¦è´¦å·å¯†ç 
2. æœåŠ¡å™¨éªŒè¯è´¦å·å¯†ç æ˜¯å¦æ­£ç¡®ï¼Œå¦‚æœä¸æ­£ç¡®ï¼Œå“åº”é”™è¯¯ï¼Œå¦‚æœæ­£ç¡®ï¼Œåœ¨å“åº”å¤´ä¸­è®¾ç½®cookieï¼Œé™„å¸¦ç™»å½•è®¤è¯ä¿¡æ¯ï¼ˆè‡³äºç™»å½•è®¤è¯ä¿¡æ¯æ˜¯è®¾ä¹ˆæ ·çš„ï¼Œå¦‚ä½•è®¾è®¡ï¼Œè¦è€ƒè™‘å“ªäº›é—®é¢˜ï¼Œå°±æ˜¯å¦ä¸€ä¸ªè¯é¢˜äº†ï¼Œå¯ä»¥ç™¾åº¦ jwtï¼‰
3. å®¢æˆ·ç«¯æ”¶åˆ°cookieï¼Œæµè§ˆå™¨è‡ªåŠ¨è®°å½•ä¸‹æ¥



**åç»­è¯·æ±‚**

1. æµè§ˆå™¨å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨ï¼Œå¸Œæœ›æ·»åŠ ä¸€ä¸ªç®¡ç†å‘˜ï¼Œå¹¶å°†cookieè‡ªåŠ¨é™„å¸¦åˆ°è¯·æ±‚ä¸­
2. æœåŠ¡å™¨å…ˆè·å–cookieï¼ŒéªŒè¯cookieä¸­çš„ä¿¡æ¯æ˜¯å¦æ­£ç¡®ï¼Œå¦‚æœä¸æ­£ç¡®ï¼Œä¸äºˆä»¥æ“ä½œï¼Œå¦‚æœæ­£ç¡®ï¼Œå®Œæˆæ­£å¸¸çš„ä¸šåŠ¡æµç¨‹

## ç™»å½•å’Œè®¤è¯

### ä½¿ç”¨cookie-parserä¸­é—´ä»¶
- åŠ å…¥```cookie-parser```ä¸­é—´ä»¶
- åŠ å…¥ä¹‹åï¼Œä¼šåœ¨reqå¯¹è±¡ä¸­æ³¨å…¥cookieså±æ€§ï¼Œç”¨äºè·å–æ‰€æœ‰è¯·æ±‚ä¼ é€’è¿‡æ¥çš„cookie
- åŠ å…¥ä¹‹åï¼Œä¼šåœ¨reså¯¹ä¸­æ³¨å…¥cookieæ–¹æ³•ï¼Œ ç”¨äºè®¾ç½®cookie
```js
const cookieParser = requier('cookie-parser');
app.use(cookieParser())

app.use((req,res) => {
   res.cookie("token", "å”¯ä¸€ä»¤ç‰Œå­—ç¬¦ä¸²", {
      path: '/',  // è·¯å¾„
      domain: "localhost", // åŸŸ 
      maxAge: 7 * 24 * 3600 * 1000, //æ¯«ç§’æ•°
      httpOnly: true
   })
})
```
### ç™»å½•æˆåŠŸåç»™äºˆtoken

- é€šè¿‡cookieç»™äºˆï¼š é€‚é…æµè§ˆå™¨
```js
const cookieParser = requier('cookie-parser');
app.use(cookieParser())

app.use((req,res) => {
   var result = "å”¯ä¸€ä»¤ç‰Œå­—ç¬¦ä¸²";

   res.cookie("token",  result , {
      path: '/',  // è·¯å¾„
      domain: "localhost", // åŸŸ 
      maxAge: 7 * 24 * 3600 * 1000, //æ¯«ç§’æ•°
      httpOnly: true
   })
})
```
- é€šè¿‡headerç»™äºˆï¼š é€‚é…å…¶ä»–ç»ˆç«¯
```js
res.header("authorization", result )
```

- å¯¹åç»­è¯·æ±‚è¿›è¡Œè®¤è¯
  + è§£æcookieæˆ–è€…headerä¸­çš„token
  + éªŒè¯token  
    * é€šè¿‡ï¼šç»§ç»­åç»­å¤„ç†  
    * æœªé€šè¿‡ï¼šç»™äºˆé”™è¯¯ 
         
```tokenMiddleware.js```
```js
module.exports = (req, res, next) => {
    let token = req.cookies.token;
    if(!token){
        // ä»headerçš„authorizationä¸­è·å–
        token = req.headers.authorization;
    }
    if(!token){
        // æ²¡æœ‰è®¤è¯
        handleNoToken(req, res, next)
    }

};

// å¤„ç†æ²¡æœ‰è®¤è¯çš„æƒ…å†µ
function handleNoToken(req, res, next){
    
}
```
### å¯¹ç§°åŠ å¯† aes 128
- å¯¹ç§°åŠ å¯†token
- 128ä½çš„å¯†é’¥

```js
// ä½¿ç”¨å¯¹ç§°åŠ å¯†ç®—æ³•ï¼š aes 128
// 128 ä½çš„å¯†é’¥

const secret = Buffer.from("mm7h3ck87ugk9l4a");
const crypto = require("crypto");

// å‡†å¤‡ä¸€ä¸ªivï¼Œ éšæœºå‘é‡
const iv = Buffer.from("7uzue51hw7dsxe0b");


exports.encrypt = function (str){
    const cry = crypto.createCipheriv("aes-128-cbc", secret, iv);
    // ç¬¬ä¸€ä¸ªå‚æ•° åŠ å¯†çš„æ•°æ®
    // ç¬¬äºŒä¸ªå‚æ•° ä¼ å…¥åŠ å¯†æ•°æ®æ˜¯ä»€ä¹ˆç±»å‹ï¼Œ
    // ç¬¬ä¸‰ä¸ªå‚æ•° åŠ å¯†æ•°æ®ä¹‹åçš„è¾“å‡ºç±»å‹
    let result = cry.update(str, "utf-8", "hex");
    result += cry.final("hex"); // è¾“å‡ºçš„encoding
    return result;
}

exports.decrypt = function (str){
    // str åŠ å¯†è¿‡åçš„å­—ç¬¦ä¸²
    const decry = crypto.createDecipheriv("aes-128-cbc", secret, iv);
    // ç¬¬ä¸€ä¸ªå‚æ•° è§£å¯†çš„æ•°æ®
    // ç¬¬äºŒä¸ªå‚æ•° ä¼ å…¥è§£å¯†æ•°æ®æ˜¯ä»€ä¹ˆç±»å‹ï¼Œ
    // ç¬¬ä¸‰ä¸ªå‚æ•° è§£å¯†æ•°æ®ä¹‹åçš„è¾“å‡ºç±»å‹
    let result = decry.update(str, "hex", "utf-8")
    result += decry.final("utf-8");  // è¾“å‡ºçš„encoding
    return result;
}

```
### node æ–­ç‚¹è°ƒè¯•

**node --inspectå¯åŠ¨æ¨¡å—**  
**nodeè¿›ç¨‹ä¼šç›‘å¬9299ç«¯å£**


## è·¨åŸŸå€¼JSONP

- åŒæºç­–ç•¥
  - åŒæº
    1. åè®®
    2. ç«¯å£
    3. ä¸»æœºå
    4. å®Œå…¨ç›¸åŒ
  - æµè§ˆå™¨ä¸å…è®¸ä½¿ç”¨éåŒæºçš„æ•°æ®

- è§£å†³æ–¹æ¡ˆ
  - JSONP
  - CORS
- JSONP  
  - 1ã€æµè§ˆå™¨ç«¯ç”Ÿæˆä¸€ä¸ªscriptå…ƒç´ ï¼Œè®¿é—®æ•°æ®æ¥å£
  - 2ã€æœåŠ¡å™¨å“åº”ä¸€æ®µJSä»£ç ï¼Œè°ƒç”¨æŸä¸€ä¸ªå‡½æ•°ï¼Œå¹¶æŠŠå“åº”çš„æ•°æ®ä¼ å…¥
- JSONPçš„ç¼ºé™·
  - 1ã€ä¼šä¸¥é‡å½±å“æœåŠ¡å™¨çš„æ­£å¸¸å“åº”æ ¼å¼
  - 2ã€åªèƒ½ä½¿ç”¨GETè¯·æ±‚
  
## è·¨åŸŸä¹‹CORS

> é˜…è¯»æœ¬æ–‡ï¼Œä½ éœ€è¦é¦–å…ˆçŸ¥é“ï¼š
>
> 1. æµè§ˆå™¨çš„åŒæºç­–ç•¥
> 2. è·¨åŸŸé—®é¢˜
> 3. JSONPåŸç†
> 4. cookieåŸç†

JSONPå¹¶ä¸æ˜¯ä¸€ä¸ªå¥½çš„è·¨åŸŸè§£å†³æ–¹æ¡ˆï¼Œå®ƒè‡³å°‘æœ‰ç€ä¸‹é¢ä¸¤ä¸ªä¸¥é‡é—®é¢˜ï¼š

1. **ä¼šæ‰“ä¹±æœåŠ¡å™¨çš„æ¶ˆæ¯æ ¼å¼**ï¼šJSONPè¦æ±‚æœåŠ¡å™¨å“åº”ä¸€æ®µJSä»£ç ï¼Œä½†åœ¨éè·¨åŸŸçš„æƒ…å†µä¸‹ï¼ŒæœåŠ¡å™¨åˆéœ€è¦å“åº”ä¸€ä¸ªæ­£å¸¸çš„JSONæ ¼å¼
2. **åªèƒ½å®ŒæˆGETè¯·æ±‚**ï¼šJSONPçš„åŸç†ä¼šè¦æ±‚æµè§ˆå™¨ç«¯ç”Ÿæˆä¸€ä¸ª`script`å…ƒç´ ï¼Œè€Œ`script`å…ƒç´ å‘å‡ºçš„è¯·æ±‚åªèƒ½æ˜¯`get`è¯·æ±‚

æ‰€ä»¥ï¼ŒCORSæ˜¯ä¸€ç§æ›´å¥½çš„è·¨åŸŸè§£å†³æ–¹æ¡ˆã€‚

### æ¦‚è¿°

`CORS`æ˜¯åŸºäº`http1.1`çš„ä¸€ç§è·¨åŸŸè§£å†³æ–¹æ¡ˆï¼Œå®ƒçš„å…¨ç§°æ˜¯**C**ross-**O**rigin **R**esource **S**haringï¼Œè·¨åŸŸèµ„æºå…±äº«ã€‚

å®ƒçš„æ€»ä½“æ€è·¯æ˜¯ï¼š**å¦‚æœæµè§ˆå™¨è¦è·¨åŸŸè®¿é—®æœåŠ¡å™¨çš„èµ„æºï¼Œéœ€è¦è·å¾—æœåŠ¡å™¨çš„å…è®¸**

![image-20200421152122793](assets/3.png)

è€Œè¦çŸ¥é“ï¼Œä¸€ä¸ªè¯·æ±‚å¯ä»¥é™„å¸¦å¾ˆå¤šä¿¡æ¯ï¼Œä»è€Œä¼šå¯¹æœåŠ¡å™¨é€ æˆä¸åŒç¨‹åº¦çš„å½±å“

æ¯”å¦‚æœ‰çš„è¯·æ±‚åªæ˜¯è·å–ä¸€äº›æ–°é—»ï¼Œæœ‰çš„è¯·æ±‚ä¼šæ”¹åŠ¨æœåŠ¡å™¨çš„æ•°æ®

é’ˆå¯¹ä¸åŒçš„è¯·æ±‚ï¼ŒCORSè§„å®šäº†ä¸‰ç§ä¸åŒçš„äº¤äº’æ¨¡å¼ï¼Œåˆ†åˆ«æ˜¯ï¼š

- **ç®€å•è¯·æ±‚**
- **éœ€è¦é¢„æ£€çš„è¯·æ±‚**
- **é™„å¸¦èº«ä»½å‡­è¯çš„è¯·æ±‚**

è¿™ä¸‰ç§æ¨¡å¼ä»ä¸Šåˆ°ä¸‹å±‚å±‚é€’è¿›ï¼Œè¯·æ±‚å¯ä»¥åšçš„äº‹è¶Šæ¥è¶Šå¤šï¼Œè¦æ±‚ä¹Ÿè¶Šæ¥è¶Šä¸¥æ ¼ã€‚

ä¸‹é¢åˆ†åˆ«è¯´æ˜ä¸‰ç§è¯·æ±‚æ¨¡å¼çš„å…·ä½“è§„èŒƒã€‚

### ç®€å•è¯·æ±‚

å½“æµè§ˆå™¨ç«¯è¿è¡Œäº†ä¸€æ®µajaxä»£ç ï¼ˆæ— è®ºæ˜¯ä½¿ç”¨XMLHttpRequestè¿˜æ˜¯fetch apiï¼‰ï¼Œæµè§ˆå™¨ä¼šé¦–å…ˆåˆ¤æ–­å®ƒå±äºå“ªä¸€ç§è¯·æ±‚æ¨¡å¼

#### ç®€å•è¯·æ±‚çš„åˆ¤å®š

å½“è¯·æ±‚**åŒæ—¶æ»¡è¶³**ä»¥ä¸‹æ¡ä»¶æ—¶ï¼Œæµè§ˆå™¨ä¼šè®¤ä¸ºå®ƒæ˜¯ä¸€ä¸ªç®€å•è¯·æ±‚ï¼š

1. **è¯·æ±‚æ–¹æ³•å±äºä¸‹é¢çš„ä¸€ç§ï¼š**
   - get
   - post
   - head
2. **è¯·æ±‚å¤´ä»…åŒ…å«å®‰å…¨çš„å­—æ®µï¼Œå¸¸è§çš„å®‰å…¨å­—æ®µå¦‚ä¸‹ï¼š**
   - `Accept`
   - `Accept-Language`
   - `Content-Language`
   - `Content-Type`
   - `DPR`
   - `Downlink`
   - `Save-Data`
   - `Viewport-Width`
   - `Width`

3. **è¯·æ±‚å¤´å¦‚æœåŒ…å«`Content-Type`ï¼Œä»…é™ä¸‹é¢çš„å€¼ä¹‹ä¸€ï¼š**
   - `text/plain`
   - `multipart/form-data`
   - `application/x-www-form-urlencoded`

å¦‚æœä»¥ä¸Šä¸‰ä¸ªæ¡ä»¶åŒæ—¶æ»¡è¶³ï¼Œæµè§ˆå™¨åˆ¤å®šä¸ºç®€å•è¯·æ±‚ã€‚

ä¸‹é¢æ˜¯ä¸€äº›ä¾‹å­ï¼š

```js
// ç®€å•è¯·æ±‚
fetch("http://crossdomain.com/api/news");

// è¯·æ±‚æ–¹æ³•ä¸æ»¡è¶³è¦æ±‚ï¼Œä¸æ˜¯ç®€å•è¯·æ±‚
fetch("http://crossdomain.com/api/news", {
  method:"PUT"
})

// åŠ å…¥äº†é¢å¤–çš„è¯·æ±‚å¤´ï¼Œä¸æ˜¯ç®€å•è¯·æ±‚
fetch("http://crossdomain.com/api/news", {
  headers:{
    a: 1
  }
})

// ç®€å•è¯·æ±‚
fetch("http://crossdomain.com/api/news", {
  method: "post"
})

// content-typeä¸æ»¡è¶³è¦æ±‚ï¼Œä¸æ˜¯ç®€å•è¯·æ±‚
fetch("http://crossdomain.com/api/news", {
  method: "post",
  headers: {
    "content-type": "application/json"
  }
})
```

#### ç®€å•è¯·æ±‚çš„äº¤äº’è§„èŒƒ

å½“æµè§ˆå™¨åˆ¤å®šæŸä¸ª**ajaxè·¨åŸŸè¯·æ±‚**æ˜¯**ç®€å•è¯·æ±‚**æ—¶ï¼Œä¼šå‘ç”Ÿä»¥ä¸‹çš„äº‹æƒ…

1. **è¯·æ±‚å¤´ä¸­ä¼šè‡ªåŠ¨æ·»åŠ `Origin`å­—æ®µ**

æ¯”å¦‚ï¼Œåœ¨é¡µé¢`http://my.com/index.html`ä¸­æœ‰ä»¥ä¸‹ä»£ç é€ æˆäº†è·¨åŸŸ

```js
// ç®€å•è¯·æ±‚
fetch("http://crossdomain.com/api/news");
```

è¯·æ±‚å‘å‡ºåï¼Œè¯·æ±‚å¤´ä¼šæ˜¯ä¸‹é¢çš„æ ¼å¼ï¼š

```
GET /api/news/ HTTP/1.1
Host: crossdomain.com
Connection: keep-alive
...
Referer: http://my.com/index.html
Origin: http://my.com
```

çœ‹åˆ°æœ€åä¸€è¡Œæ²¡ï¼Œ`Origin`å­—æ®µä¼šå‘Šè¯‰æœåŠ¡å™¨ï¼Œæ˜¯å“ªä¸ªæºåœ°å€åœ¨è·¨åŸŸè¯·æ±‚

2. **æœåŠ¡å™¨å“åº”å¤´ä¸­åº”åŒ…å«`Access-Control-Allow-Origin`**

å½“æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚åï¼Œå¦‚æœå…è®¸è¯¥è¯·æ±‚è·¨åŸŸè®¿é—®ï¼Œéœ€è¦åœ¨å“åº”å¤´ä¸­æ·»åŠ `Access-Control-Allow-Origin`å­—æ®µ

è¯¥å­—æ®µçš„å€¼å¯ä»¥æ˜¯ï¼š

- *ï¼šè¡¨ç¤ºæˆ‘å¾ˆå¼€æ”¾ï¼Œä»€ä¹ˆäººæˆ‘éƒ½å…è®¸è®¿é—®
- å…·ä½“çš„æºï¼šæ¯”å¦‚`http://my.com`ï¼Œè¡¨ç¤ºæˆ‘å°±å…è®¸ä½ è®¿é—®

> å®é™…ä¸Šï¼Œè¿™ä¸¤ä¸ªå€¼å¯¹äºå®¢æˆ·ç«¯`http://my.com`è€Œè¨€ï¼Œéƒ½ä¸€æ ·ï¼Œå› ä¸ºå®¢æˆ·ç«¯æ‰ä¸ä¼šç®¡å…¶ä»–æºæœåŠ¡å™¨å…ä¸å…è®¸ï¼Œå°±å…³å¿ƒè‡ªå·±æ˜¯å¦è¢«å…è®¸
>
> å½“ç„¶ï¼ŒæœåŠ¡å™¨ä¹Ÿå¯ä»¥ç»´æŠ¤ä¸€ä¸ªå¯è¢«å…è®¸çš„æºåˆ—è¡¨ï¼Œå¦‚æœè¯·æ±‚çš„`Origin`å‘½ä¸­è¯¥åˆ—è¡¨ï¼Œæ‰å“åº”`*`æˆ–å…·ä½“çš„æº
>
> **ä¸ºäº†é¿å…åç»­çš„éº»çƒ¦ï¼Œå¼ºçƒˆæ¨èå“åº”å…·ä½“çš„æº**

å‡è®¾æœåŠ¡å™¨åšå‡ºäº†ä»¥ä¸‹çš„å“åº”ï¼š

```
HTTP/1.1 200 OK
Date: Tue, 21 Apr 2020 08:03:35 GMT
...
Access-Control-Allow-Origin: http://my.com
...

æ¶ˆæ¯ä½“ä¸­çš„æ•°æ®
```

å½“æµè§ˆå™¨çœ‹åˆ°æœåŠ¡å™¨å…è®¸è‡ªå·±è®¿é—®åï¼Œé«˜å…´çš„åƒä¸€ä¸ªä¸¤ç™¾æ–¤çš„å­©å­ï¼Œäºæ˜¯ï¼Œå®ƒå°±æŠŠå“åº”é¡ºåˆ©çš„äº¤ç»™jsï¼Œä»¥å®Œæˆåç»­çš„æ“ä½œ

ä¸‹å›¾ç®€è¿°äº†æ•´ä¸ªäº¤äº’è¿‡ç¨‹

![image-20200421162846480](assets/jiaohu1.png)

#### éœ€è¦é¢„æ£€çš„è¯·æ±‚

ç®€å•çš„è¯·æ±‚å¯¹æœåŠ¡å™¨çš„å¨èƒä¸å¤§ï¼Œæ‰€ä»¥å…è®¸ä½¿ç”¨ä¸Šè¿°çš„ç®€å•äº¤äº’å³å¯å®Œæˆã€‚

ä½†æ˜¯ï¼Œå¦‚æœæµè§ˆå™¨ä¸è®¤ä¸ºè¿™æ˜¯ä¸€ç§ç®€å•è¯·æ±‚ï¼Œå°±ä¼šæŒ‰ç…§ä¸‹é¢çš„æµç¨‹è¿›è¡Œï¼š

1. **æµè§ˆå™¨å‘é€é¢„æ£€è¯·æ±‚ï¼Œè¯¢é—®æœåŠ¡å™¨æ˜¯å¦å…è®¸**
2. **æœåŠ¡å™¨å…è®¸**
3. **æµè§ˆå™¨å‘é€çœŸå®è¯·æ±‚**
4. **æœåŠ¡å™¨å®ŒæˆçœŸå®çš„å“åº”**

æ¯”å¦‚ï¼Œåœ¨é¡µé¢`http://my.com/index.html`ä¸­æœ‰ä»¥ä¸‹ä»£ç é€ æˆäº†è·¨åŸŸ

```js
// éœ€è¦é¢„æ£€çš„è¯·æ±‚
fetch("http://crossdomain.com/api/user", {
  method:"POST", // post è¯·æ±‚
  headers:{  // è®¾ç½®è¯·æ±‚å¤´
    a: 1,
    b: 2,
    "content-type": "application/json"
  },
  body: JSON.stringify({ name: "è¢å°è¿›", age: 18 }) // è®¾ç½®è¯·æ±‚ä½“
});
```

æµè§ˆå™¨å‘ç°å®ƒä¸æ˜¯ä¸€ä¸ªç®€å•è¯·æ±‚ï¼Œåˆ™ä¼šæŒ‰ç…§ä¸‹é¢çš„æµç¨‹ä¸æœåŠ¡å™¨äº¤äº’

1. **æµè§ˆå™¨å‘é€é¢„æ£€è¯·æ±‚ï¼Œè¯¢é—®æœåŠ¡å™¨æ˜¯å¦å…è®¸**

```
OPTIONS /api/user HTTP/1.1
Host: crossdomain.com
...
Origin: http://my.com
Access-Control-Request-Method: POST
Access-Control-Request-Headers: a, b, content-type
```

å¯ä»¥çœ‹å‡ºï¼Œè¿™å¹¶éæˆ‘ä»¬æƒ³è¦å‘å‡ºçš„çœŸå®è¯·æ±‚ï¼Œè¯·æ±‚ä¸­ä¸åŒ…å«æˆ‘ä»¬çš„å“åº”å¤´ï¼Œä¹Ÿæ²¡æœ‰æ¶ˆæ¯ä½“ã€‚

è¿™æ˜¯ä¸€ä¸ªé¢„æ£€è¯·æ±‚ï¼Œå®ƒçš„ç›®çš„æ˜¯è¯¢é—®æœåŠ¡å™¨ï¼Œæ˜¯å¦å…è®¸åç»­çš„çœŸå®è¯·æ±‚ã€‚

é¢„æ£€è¯·æ±‚**æ²¡æœ‰è¯·æ±‚ä½“**ï¼Œå®ƒåŒ…å«äº†åç»­çœŸå®è¯·æ±‚è¦åšçš„äº‹æƒ…

é¢„æ£€è¯·æ±‚æœ‰ä»¥ä¸‹ç‰¹å¾ï¼š

- è¯·æ±‚æ–¹æ³•ä¸º`OPTIONS`
- æ²¡æœ‰è¯·æ±‚ä½“
- è¯·æ±‚å¤´ä¸­åŒ…å«
  - `Origin`ï¼šè¯·æ±‚çš„æºï¼Œå’Œç®€å•è¯·æ±‚çš„å«ä¹‰ä¸€è‡´
  - `Access-Control-Request-Method`ï¼šåç»­çš„çœŸå®è¯·æ±‚å°†ä½¿ç”¨çš„è¯·æ±‚æ–¹æ³•
  - `Access-Control-Request-Headers`ï¼šåç»­çš„çœŸå®è¯·æ±‚ä¼šæ”¹åŠ¨çš„è¯·æ±‚å¤´

2. **æœåŠ¡å™¨å…è®¸**

æœåŠ¡å™¨æ”¶åˆ°é¢„æ£€è¯·æ±‚åï¼Œå¯ä»¥æ£€æŸ¥é¢„æ£€è¯·æ±‚ä¸­åŒ…å«çš„ä¿¡æ¯ï¼Œå¦‚æœå…è®¸è¿™æ ·çš„è¯·æ±‚ï¼Œéœ€è¦å“åº”ä¸‹é¢çš„æ¶ˆæ¯æ ¼å¼

```
HTTP/1.1 200 OK
Date: Tue, 21 Apr 2020 08:03:35 GMT
...
Access-Control-Allow-Origin: http://my.com
Access-Control-Allow-Methods: POST
Access-Control-Allow-Headers: a, b, content-type
Access-Control-Max-Age: 86400
...
```

å¯¹äºé¢„æ£€è¯·æ±‚ï¼Œä¸éœ€è¦å“åº”ä»»ä½•çš„æ¶ˆæ¯ä½“ï¼Œåªéœ€è¦åœ¨å“åº”å¤´ä¸­æ·»åŠ ï¼š

- `Access-Control-Allow-Origin`ï¼šå’Œç®€å•è¯·æ±‚ä¸€æ ·ï¼Œè¡¨ç¤ºå…è®¸çš„æº
- `Access-Control-Allow-Methods`ï¼šè¡¨ç¤ºå…è®¸çš„åç»­çœŸå®çš„è¯·æ±‚æ–¹æ³•
- `Access-Control-Allow-Headers`ï¼šè¡¨ç¤ºå…è®¸æ”¹åŠ¨çš„è¯·æ±‚å¤´
- `Access-Control-Max-Age`ï¼šå‘Šè¯‰æµè§ˆå™¨ï¼Œå¤šå°‘ç§’å†…ï¼Œå¯¹äºåŒæ ·çš„è¯·æ±‚æºã€æ–¹æ³•ã€å¤´ï¼Œéƒ½ä¸éœ€è¦å†å‘é€é¢„æ£€è¯·æ±‚äº†

3. **æµè§ˆå™¨å‘é€çœŸå®è¯·æ±‚**

é¢„æ£€è¢«æœåŠ¡å™¨å…è®¸åï¼Œæµè§ˆå™¨å°±ä¼šå‘é€çœŸå®è¯·æ±‚äº†ï¼Œä¸Šé¢çš„ä»£ç ä¼šå‘ç”Ÿä¸‹é¢çš„è¯·æ±‚æ•°æ®

```
POST /api/user HTTP/1.1
Host: crossdomain.com
Connection: keep-alive
...
Referer: http://my.com/index.html
Origin: http://my.com

{"name": "è¢å°è¿›", "age": 18 }
```

4. **æœåŠ¡å™¨å“åº”çœŸå®è¯·æ±‚**

```
HTTP/1.1 200 OK
Date: Tue, 21 Apr 2020 08:03:35 GMT
...
Access-Control-Allow-Origin: http://my.com
...

æ·»åŠ ç”¨æˆ·æˆåŠŸ
```



å¯ä»¥çœ‹å‡ºï¼Œå½“å®Œæˆé¢„æ£€ä¹‹åï¼Œåç»­çš„å¤„ç†ä¸ç®€å•è¯·æ±‚ç›¸åŒ

ä¸‹å›¾ç®€è¿°äº†æ•´ä¸ªäº¤äº’è¿‡ç¨‹

![image-20200421165913320](assets/jiaohu2.png)

#### é™„å¸¦èº«ä»½å‡­è¯çš„è¯·æ±‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œajaxçš„è·¨åŸŸè¯·æ±‚å¹¶ä¸ä¼šé™„å¸¦cookieï¼Œè¿™æ ·ä¸€æ¥ï¼ŒæŸäº›éœ€è¦æƒé™çš„æ“ä½œå°±æ— æ³•è¿›è¡Œ

ä¸è¿‡å¯ä»¥é€šè¿‡ç®€å•çš„é…ç½®å°±å¯ä»¥å®ç°é™„å¸¦cookie

```js
// xhr
var xhr = new XMLHttpRequest();
xhr.withCredentials = true;

// fetch api
fetch(url, {
  credentials: "include"
})
```

è¿™æ ·ä¸€æ¥ï¼Œè¯¥è·¨åŸŸçš„ajaxè¯·æ±‚å°±æ˜¯ä¸€ä¸ª*é™„å¸¦èº«ä»½å‡­è¯çš„è¯·æ±‚*

å½“ä¸€ä¸ªè¯·æ±‚éœ€è¦é™„å¸¦cookieæ—¶ï¼Œæ— è®ºå®ƒæ˜¯ç®€å•è¯·æ±‚ï¼Œè¿˜æ˜¯é¢„æ£€è¯·æ±‚ï¼Œéƒ½ä¼šåœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ `cookie`å­—æ®µ

è€ŒæœåŠ¡å™¨å“åº”æ—¶ï¼Œéœ€è¦æ˜ç¡®å‘ŠçŸ¥å®¢æˆ·ç«¯ï¼šæœåŠ¡å™¨å…è®¸è¿™æ ·çš„å‡­æ®

å‘ŠçŸ¥çš„æ–¹å¼ä¹Ÿéå¸¸çš„ç®€å•ï¼Œåªéœ€è¦åœ¨å“åº”å¤´ä¸­æ·»åŠ ï¼š`Access-Control-Allow-Credentials: true`å³å¯

å¯¹äºä¸€ä¸ªé™„å¸¦èº«ä»½å‡­è¯çš„è¯·æ±‚ï¼Œè‹¥æœåŠ¡å™¨æ²¡æœ‰æ˜ç¡®å‘ŠçŸ¥ï¼Œæµè§ˆå™¨ä»ç„¶è§†ä¸ºè·¨åŸŸè¢«æ‹’ç»ã€‚

å¦å¤–è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼š**å¯¹äºé™„å¸¦èº«ä»½å‡­è¯çš„è¯·æ±‚ï¼ŒæœåŠ¡å™¨ä¸å¾—è®¾ç½® `Access-Control-Allow-Origin çš„å€¼ä¸º*`**ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸æ¨èä½¿ç”¨*çš„åŸå› 

#### ä¸€ä¸ªé¢å¤–çš„è¡¥å……

åœ¨è·¨åŸŸè®¿é—®æ—¶ï¼ŒJSåªèƒ½æ‹¿åˆ°ä¸€äº›æœ€åŸºæœ¬çš„å“åº”å¤´ï¼Œå¦‚ï¼šCache-Controlã€Content-Languageã€Content-Typeã€Expiresã€Last-Modifiedã€Pragmaï¼Œå¦‚æœè¦è®¿é—®å…¶ä»–å¤´ï¼Œåˆ™éœ€è¦æœåŠ¡å™¨è®¾ç½®æœ¬å“åº”å¤´ã€‚

`Access-Control-Expose-Headers`å¤´è®©æœåŠ¡å™¨æŠŠå…è®¸æµè§ˆå™¨è®¿é—®çš„å¤´æ”¾å…¥ç™½åå•ï¼Œä¾‹å¦‚ï¼š

```
Access-Control-Expose-Headers: authorization, a, b
```

è¿™æ ·JSå°±èƒ½å¤Ÿè®¿é—®æŒ‡å®šçš„å“åº”å¤´äº†ã€‚

## CORS ä¸­é—´ä»¶
https://github.com/expressjs/cors
```yarn add cors```
```js
app.use(cors({
  // é…ç½®
}))
```


## session 

- cookie 
  - å­˜å‚¨åœ¨å®¢æˆ·ç«¯
  - ä¼˜ç‚¹
    - å­˜å‚¨åœ¨å®¢æˆ·ç«¯ï¼Œä¸å ç”¨æœåŠ¡å™¨èµ„æº
  - ç¼ºç‚¹
    - åªèƒ½æ˜¯å­—ç¬¦ä¸²æ ¼å¼
    - å­˜å‚¨é‡æœ‰é™
    - æ•°æ®å®¹æ˜“è¢«è·å–
    - æ•°æ®å®¹æ˜“è¢«ç¯¡æ”¹
    - å®¹æ˜“ä¸¢å¤±

- session
  - å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯
  - ä¼˜ç‚¹
    - å¯ä»¥æ˜¯ä»»ä½•æ ¼å¼
    - å­˜å‚¨é‡ç†è®ºä¸Šæ˜¯æ— é™çš„
    - æ•°æ®éš¾ä»¥è¢«è·å–
    - æ•°æ®éš¾ä»¥ç¯¡æ”¹
    - ä¸æ˜“ä¸¢å¤±
  - ç¼ºç‚¹
    - å ç”¨æœåŠ¡å™¨èµ„æº
    
![](assets/session1.jpg)    

```yarn add express-session```
```js
const session = require("express-session")
app.use(session({
   sercet: "werewrrwe",
   name: "sessionId"
}))
```


## jwt

éšç€å‰åç«¯åˆ†ç¦»çš„å‘å±•ï¼Œä»¥åŠæ•°æ®ä¸­å¿ƒçš„å»ºç«‹ï¼Œè¶Šæ¥è¶Šå¤šçš„å…¬å¸ä¼šåˆ›å»ºä¸€ä¸ªä¸­å¿ƒæœåŠ¡å™¨ï¼ŒæœåŠ¡äºå„ç§äº§å“çº¿ã€‚

è€Œè¿™äº›äº§å“çº¿ä¸Šçš„äº§å“ï¼Œå®ƒä»¬å¯èƒ½æœ‰ç€å„ç§ç»ˆç«¯è®¾å¤‡ï¼ŒåŒ…æ‹¬ä½†ä¸ä»…é™äºæµè§ˆå™¨ã€æ¡Œé¢åº”ç”¨ã€ç§»åŠ¨ç«¯åº”ç”¨ã€å¹³æ¿åº”ç”¨ã€ç”šè‡³æ™ºèƒ½å®¶å±…

![image-20200422163727151](assets/jwt1.png)

> å®é™…ä¸Šï¼Œä¸åŒçš„äº§å“çº¿é€šå¸¸æœ‰è‡ªå·±çš„æœåŠ¡å™¨ï¼Œäº§å“å†…éƒ¨çš„æ•°æ®ä¸€èˆ¬å’Œè‡ªå·±çš„æœåŠ¡å™¨äº¤äº’ã€‚
>
> ä½†ä¸­å¿ƒæœåŠ¡å™¨ä»ç„¶æœ‰å¿…è¦å­˜åœ¨ï¼Œå› ä¸ºåŒä¸€å®¶å…¬å¸çš„äº§å“æ€»æ˜¯ä¼šå­˜åœ¨å…±äº«çš„æ•°æ®ï¼Œæ¯”å¦‚ç”¨æˆ·æ•°æ®

è¿™äº›è®¾å¤‡ä¸ä¸­å¿ƒæœåŠ¡å™¨ä¹‹é—´ä¼šè¿›è¡Œhttpé€šä¿¡

ä¸€èˆ¬æ¥è¯´ï¼Œä¸­å¿ƒæœåŠ¡å™¨è‡³å°‘æ‰¿æ‹…ç€è®¤è¯å’Œæˆæƒçš„åŠŸèƒ½ï¼Œä¾‹å¦‚ç™»å½•ï¼šå„ç§è®¾å¤‡å‘é€æ¶ˆæ¯åˆ°ä¸­å¿ƒæœåŠ¡å™¨ï¼Œç„¶åä¸­å¿ƒæœåŠ¡å™¨å“åº”ä¸€ä¸ªèº«ä»½ä»¤ç‰Œï¼ˆå‚è§[cookieåŸç†è¯¦è§£](http://www.yuanjin.tech/article/98)ï¼‰

å½“è¿™ç§ç»“æ„å‡ºç°åï¼Œå°±å‡ºç°ä¸€ä¸ªé—®é¢˜ï¼šå®ƒä»¬ä¹‹é—´è¿˜èƒ½ä½¿ç”¨ä¼ ç»Ÿçš„cookieæ–¹å¼ä¼ é€’ä»¤ç‰Œä¿¡æ¯å—ï¼Ÿ

å…¶å®ï¼Œä¹Ÿæ˜¯å¯ä»¥çš„ğŸ¶ï¼Œå› ä¸ºcookieåœ¨ä¼ è¾“ä¸­æ— éæ˜¯ä¸€ä¸ªæ¶ˆæ¯å¤´è€Œå·²ï¼Œåªä¸è¿‡æµè§ˆå™¨å¯¹è¿™ä¸ªæ¶ˆæ¯å¤´æœ‰ç‰¹æ®Šå¤„ç†ç½¢äº†ã€‚

ä½†æµè§ˆå™¨ä¹‹å¤–çš„è®¾å¤‡è‚¯å®šä¸å–œæ¬¢cookieï¼Œå› ä¸ºæµè§ˆå™¨æœ‰ç€å¯¹cookieå®Œå–„çš„ç®¡ç†æœºåˆ¶ï¼Œä½†æ˜¯åœ¨å…¶ä»–è®¾å¤‡ä¸Šï¼Œå°±éœ€è¦å¼€å‘è€…è‡ªå·±æ‰‹åŠ¨å¤„ç†äº†

jwtçš„å‡ºç°å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜

### æ¦‚è¿°

jwtå…¨ç§°`Json Web Token`ï¼Œå¼ºè¡Œç¿»è¯‘è¿‡æ¥å°±æ˜¯`jsonæ ¼å¼çš„äº’è”ç½‘ä»¤ç‰Œ`ï¼ˆç®—äº†ï¼Œè¿˜æ˜¯ä¸è¦å¼ºè¡Œç¿»è¯‘äº†ğŸ·ï¼‰

å®ƒè¦è§£å†³çš„é—®é¢˜ï¼Œå°±æ˜¯ä¸ºå¤šç§ç»ˆç«¯è®¾å¤‡ï¼Œæä¾›**ç»Ÿä¸€çš„ã€å®‰å…¨çš„**ä»¤ç‰Œæ ¼å¼

![image-20200422165350268](assets/jwt2.png)

å› æ­¤ï¼Œjwtåªæ˜¯ä¸€ä¸ªä»¤ç‰Œæ ¼å¼è€Œå·²ï¼Œä½ å¯ä»¥æŠŠå®ƒå­˜å‚¨åˆ°cookieï¼Œä¹Ÿå¯ä»¥å­˜å‚¨åˆ°localstorageï¼Œæ²¡æœ‰ä»»ä½•é™åˆ¶ï¼

åŒæ ·çš„ï¼Œå¯¹äºä¼ è¾“ï¼Œä½ å¯ä»¥ä½¿ç”¨ä»»ä½•ä¼ è¾“æ–¹å¼æ¥ä¼ è¾“jwtï¼Œä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨æ¶ˆæ¯å¤´æ¥ä¼ è¾“å®ƒ

æ¯”å¦‚ï¼Œå½“ç™»å½•æˆåŠŸåï¼ŒæœåŠ¡å™¨å¯ä»¥ç»™å®¢æˆ·ç«¯å“åº”ä¸€ä¸ªjwtï¼š

```
HTTP/1.1 200 OK
...
set-cookie:token=jwtä»¤ç‰Œ
authorization:jwtä»¤ç‰Œ
...

{..., token:jwtä»¤ç‰Œ}
```

å¯ä»¥çœ‹åˆ°ï¼Œjwtä»¤ç‰Œå¯ä»¥å‡ºç°åœ¨å“åº”çš„ä»»ä½•ä¸€ä¸ªåœ°æ–¹ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨è‡ªè¡Œçº¦å®šå³å¯ã€‚

> å½“ç„¶ï¼Œå®ƒä¹Ÿå¯ä»¥å‡ºç°åœ¨å“åº”çš„å¤šä¸ªåœ°æ–¹ï¼Œæ¯”å¦‚ä¸ºäº†å……åˆ†åˆ©ç”¨æµè§ˆå™¨çš„cookieï¼ŒåŒæ—¶ä¸ºäº†ç…§é¡¾å…¶ä»–è®¾å¤‡ï¼Œä¹Ÿå¯ä»¥è®©jwtå‡ºç°åœ¨`set-cookie`å’Œ`authorizationæˆ–body`ä¸­ï¼Œå°½ç®¡è¿™ä¼šå¢åŠ é¢å¤–çš„ä¼ è¾“é‡ã€‚

å½“å®¢æˆ·ç«¯æ‹¿åˆ°ä»¤ç‰Œåï¼Œå®ƒè¦åšçš„åªæœ‰ä¸€ä»¶äº‹ï¼šå­˜å‚¨å®ƒã€‚

ä½ å¯ä»¥å­˜å‚¨åˆ°ä»»ä½•ä½ç½®ï¼Œæ¯”å¦‚æ‰‹æœºæ–‡ä»¶ã€PCæ–‡ä»¶ã€localstorageã€cookie

å½“åç»­è¯·æ±‚å‘ç”Ÿæ—¶ï¼Œä½ åªéœ€è¦å°†å®ƒä½œä¸ºè¯·æ±‚çš„ä¸€éƒ¨åˆ†å‘é€åˆ°æœåŠ¡å™¨å³å¯ã€‚

è™½ç„¶jwtæ²¡æœ‰æ˜ç¡®è¦æ±‚åº”è¯¥å¦‚ä½•é™„å¸¦åˆ°è¯·æ±‚ä¸­ï¼Œä½†é€šå¸¸æˆ‘ä»¬ä¼šä½¿ç”¨å¦‚ä¸‹çš„æ ¼å¼ï¼š

```
GET /api/resources HTTP/1.1
...
authorization: bearer jwtä»¤ç‰Œ
...
```

> è¿™ç§æ ¼å¼æ˜¯OAuth2é™„å¸¦tokençš„ä¸€ç§è§„èŒƒæ ¼å¼
>
> è‡³äºä»€ä¹ˆæ˜¯OAuth2ï¼Œé‚£æ˜¯å¦ä¸€ä¸ªè¯é¢˜äº†

è¿™æ ·ä¸€æ¥ï¼ŒæœåŠ¡å™¨å°±èƒ½å¤Ÿæ”¶åˆ°è¿™ä¸ªä»¤ç‰Œäº†ï¼Œé€šè¿‡å¯¹ä»¤ç‰Œçš„éªŒè¯ï¼Œå³å¯çŸ¥é“è¯¥ä»¤ç‰Œæ˜¯å¦æœ‰æ•ˆã€‚

å®ƒä»¬çš„å®Œæ•´äº¤äº’æµç¨‹æ˜¯éå¸¸ç®€å•æ¸…æ™°çš„

![image-20200422172837190](assets/jwt3.png)

### ä»¤ç‰Œçš„ç»„æˆ

ä¸ºäº†ä¿è¯ä»¤ç‰Œçš„å®‰å…¨æ€§ï¼Œjwtä»¤ç‰Œç”±ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«æ˜¯ï¼š

1. headerï¼šä»¤ç‰Œå¤´éƒ¨ï¼Œè®°å½•äº†æ•´ä¸ªä»¤ç‰Œçš„ç±»å‹å’Œç­¾åç®—æ³•
2. payloadï¼šä»¤ç‰Œè´Ÿè·ï¼Œè®°å½•äº†ä¿å­˜çš„ä¸»ä½“ä¿¡æ¯ï¼Œæ¯”å¦‚ä½ è¦ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯å°±å¯ä»¥æ”¾åˆ°è¿™é‡Œ
3. signatureï¼šä»¤ç‰Œç­¾åï¼ŒæŒ‰ç…§å¤´éƒ¨å›ºå®šçš„ç­¾åç®—æ³•å¯¹æ•´ä¸ªä»¤ç‰Œè¿›è¡Œç­¾åï¼Œè¯¥ç­¾åçš„ä½œç”¨æ˜¯ï¼šä¿è¯ä»¤ç‰Œä¸è¢«ä¼ªé€ å’Œç¯¡æ”¹

å®ƒä»¬ç»„åˆè€Œæˆçš„å®Œæ•´æ ¼å¼æ˜¯ï¼š`header.payload.signature`

æ¯”å¦‚ï¼Œä¸€ä¸ªå®Œæ•´çš„jwtä»¤ç‰Œå¦‚ä¸‹ï¼š

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmb28iOiJiYXIiLCJpYXQiOjE1ODc1NDgyMTV9.BCwUy3jnUQ_E6TqCayc7rCHkx-vxxdagUwPOWqwYCFc
```

å®ƒå„ä¸ªéƒ¨åˆ†çš„å€¼åˆ†åˆ«æ˜¯ï¼š

- `headerï¼šeyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9`
- `payloadï¼šeyJmb28iOiJiYXIiLCJpYXQiOjE1ODc1NDgyMTV9`
- `signature: BCwUy3jnUQ_E6TqCayc7rCHkx-vxxdagUwPOWqwYCFc`

ä¸‹é¢åˆ†åˆ«å¯¹æ¯ä¸ªéƒ¨åˆ†è¿›è¡Œè¯´æ˜

### header

å®ƒæ˜¯ä»¤ç‰Œå¤´éƒ¨ï¼Œè®°å½•äº†æ•´ä¸ªä»¤ç‰Œçš„ç±»å‹å’Œç­¾åç®—æ³•

å®ƒçš„æ ¼å¼æ˜¯ä¸€ä¸ª`json`å¯¹è±¡ï¼Œå¦‚ä¸‹ï¼š

```json
{
  "alg":"HS256",
  "typ":"JWT"
}
```

è¯¥å¯¹è±¡è®°å½•äº†ï¼š

- algï¼šsignatureéƒ¨åˆ†ä½¿ç”¨çš„ç­¾åç®—æ³•ï¼Œé€šå¸¸å¯ä»¥å–ä¸¤ä¸ªå€¼
  - HS256ï¼šä¸€ç§å¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œä½¿ç”¨åŒä¸€ä¸ªç§˜é’¥å¯¹signatureåŠ å¯†è§£å¯†
  - RS256ï¼šä¸€ç§éå¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œä½¿ç”¨ç§é’¥åŠ å¯†ï¼Œå…¬é’¥è§£å¯†
- typï¼šæ•´ä¸ªä»¤ç‰Œçš„ç±»å‹ï¼Œå›ºå®šå†™`JWT`å³å¯

è®¾ç½®å¥½äº†`header`ä¹‹åï¼Œå°±å¯ä»¥ç”Ÿæˆ`header`éƒ¨åˆ†äº†

å…·ä½“çš„ç”Ÿæˆæ–¹å¼åŠå…¶ç®€å•ï¼Œå°±æ˜¯æŠŠ`header`éƒ¨åˆ†ä½¿ç”¨`base64 url`ç¼–ç å³å¯

> `base64 url`ä¸æ˜¯ä¸€ä¸ªåŠ å¯†ç®—æ³•ï¼Œè€Œæ˜¯ä¸€ç§ç¼–ç æ–¹å¼ï¼Œå®ƒæ˜¯åœ¨`base64`ç®—æ³•çš„åŸºç¡€ä¸Šå¯¹`+`ã€`=`ã€`/`ä¸‰ä¸ªå­—ç¬¦åšå‡ºç‰¹æ®Šå¤„ç†çš„ç®—æ³•
>
> è€Œ`base64`æ˜¯ä½¿ç”¨64ä¸ªå¯æ‰“å°å­—ç¬¦æ¥è¡¨ç¤ºä¸€ä¸ªäºŒè¿›åˆ¶æ•°æ®ï¼Œå…·ä½“çš„åšæ³•å‚è€ƒ[ç™¾åº¦ç™¾ç§‘](https://baike.baidu.com/item/base64/8545775?fr=aladdin)

æµè§ˆå™¨æä¾›äº†`btoa`å‡½æ•°ï¼Œå¯ä»¥å®Œæˆè¿™ä¸ªæ“ä½œï¼š

```js
window.btoa(JSON.stringify({
  "alg":"HS256",
  "typ":"JWT"
}))
// å¾—åˆ°å­—ç¬¦ä¸²ï¼šeyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9
```

åŒæ ·çš„ï¼Œæµè§ˆå™¨ä¹Ÿæä¾›äº†`atob`å‡½æ•°ï¼Œå¯ä»¥å¯¹å…¶è¿›è¡Œè§£ç ï¼š

```js
window.atob("eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9")
// å¾—åˆ°å­—ç¬¦ä¸²ï¼š{"alg":"HS256","typ":"JWT"}
```

> nodejsä¸­æ²¡æœ‰æä¾›è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œå¯ä»¥å®‰è£…ç¬¬ä¸‰æ–¹åº“`atob`å’Œ`bota`æå®š
>
> æˆ–è€…ï¼Œæ‰‹åŠ¨æå®š

### payload

è¿™éƒ¨åˆ†æ˜¯jwtçš„ä¸»ä½“ä¿¡æ¯ï¼Œå®ƒä»ç„¶æ˜¯ä¸€ä¸ªJSONå¯¹è±¡ï¼Œå®ƒå¯ä»¥åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

```json
{
  "ss"ï¼š"å‘è¡Œè€…",
	"iat"ï¼š"å‘å¸ƒæ—¶é—´",
	"exp"ï¼š"åˆ°æœŸæ—¶é—´",
	"sub"ï¼š"ä¸»é¢˜",
	"aud"ï¼š"å¬ä¼—",
	"nbf"ï¼š"åœ¨æ­¤ä¹‹å‰ä¸å¯ç”¨",
  "jti"ï¼š"JWT ID"
}
```

ä»¥ä¸Šå±æ€§å¯ä»¥å…¨å†™ï¼Œä¹Ÿå¯ä»¥ä¸€ä¸ªéƒ½ä¸å†™ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªè§„èŒƒï¼Œå°±ç®—å†™äº†ï¼Œä¹Ÿéœ€è¦ä½ åœ¨å°†æ¥éªŒè¯è¿™ä¸ªjwtä»¤ç‰Œæ—¶æ‰‹åŠ¨å¤„ç†æ‰èƒ½å‘æŒ¥ä½œç”¨

ä¸Šè¿°å±æ€§è¡¨è¾¾çš„å«ä¹‰åˆ†åˆ«æ˜¯ï¼š

- ssï¼šå‘è¡Œè¯¥jwtçš„æ˜¯è°ï¼Œå¯ä»¥å†™å…¬å¸åå­—ï¼Œä¹Ÿå¯ä»¥å†™æœåŠ¡åç§°
- iatï¼šè¯¥jwtçš„å‘æ”¾æ—¶é—´ï¼Œé€šå¸¸å†™å½“å‰æ—¶é—´çš„æ—¶é—´æˆ³
- expï¼šè¯¥jwtçš„åˆ°æœŸæ—¶é—´ï¼Œé€šå¸¸å†™æ—¶é—´æˆ³
- subï¼šè¯¥jwtæ˜¯ç”¨äºå¹²å˜›çš„
- audï¼šè¯¥jwtæ˜¯å‘æ”¾ç»™å“ªä¸ªç»ˆç«¯çš„ï¼Œå¯ä»¥æ˜¯ç»ˆç«¯ç±»å‹ï¼Œä¹Ÿå¯ä»¥æ˜¯ç”¨æˆ·åç§°ï¼Œéšæ„ä¸€ç‚¹
- nbfï¼šä¸€ä¸ªæ—¶é—´ç‚¹ï¼Œåœ¨è¯¥æ—¶é—´ç‚¹åˆ°è¾¾ä¹‹å‰ï¼Œè¿™ä¸ªä»¤ç‰Œæ˜¯ä¸å¯ç”¨çš„
- jtiï¼šjwtçš„å”¯ä¸€ç¼–å·ï¼Œè®¾ç½®æ­¤é¡¹çš„ç›®çš„ï¼Œä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢é‡æ”¾æ”»å‡»ï¼ˆé‡æ”¾æ”»å‡»æ˜¯åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œç”¨æˆ·ä½¿ç”¨ä¹‹å‰çš„ä»¤ç‰Œå‘é€åˆ°æœåŠ¡å™¨ï¼Œè¢«æœåŠ¡å™¨æ­£ç¡®çš„è¯†åˆ«ï¼Œä»è€Œå¯¼è‡´ä¸å¯é¢„æœŸçš„è¡Œä¸ºå‘ç”Ÿï¼‰

å¯æ˜¯åˆ°ç°åœ¨ï¼Œçœ‹äº†åŠå¤©ï¼Œæ²¡æœ‰å‡ºç°æˆ‘æƒ³è¦å†™å…¥çš„æ•°æ®å•ŠğŸ˜‚

å½“ç”¨æˆ·ç™»é™†æˆåŠŸä¹‹åï¼Œæˆ‘å¯èƒ½éœ€è¦æŠŠç”¨æˆ·çš„ä¸€äº›ä¿¡æ¯å†™å…¥åˆ°jwtä»¤ç‰Œä¸­ï¼Œæ¯”å¦‚ç”¨æˆ·idã€è´¦å·ç­‰ç­‰ï¼ˆå¯†ç å°±ç®—äº†ğŸ˜³ï¼‰

å…¶å®å¾ˆç®€å•ï¼Œpayloadè¿™ä¸€éƒ¨åˆ†åªæ˜¯ä¸€ä¸ªjsonå¯¹è±¡è€Œå·²ï¼Œä½ å¯ä»¥å‘å¯¹è±¡ä¸­åŠ å…¥ä»»ä½•æƒ³è¦åŠ å…¥çš„ä¿¡æ¯

æ¯”å¦‚ï¼Œä¸‹é¢çš„jsonå¯¹è±¡ä»ç„¶æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„payload

```json
{
  "foo":"bar",
  "iat":1587548215
}
```

`foo: bar`æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ä¿¡æ¯ï¼Œ`iat: 1587548215`æ˜¯jwtè§„èŒƒä¸­çš„ä¿¡æ¯

æœ€ç»ˆï¼Œpayloadéƒ¨åˆ†å’Œheaderä¸€æ ·ï¼Œéœ€è¦é€šè¿‡`base64 url`ç¼–ç å¾—åˆ°ï¼š

```js
window.btoa(JSON.stringify({
  "foo":"bar",
  "iat":1587548215
}))
// å¾—åˆ°å­—ç¬¦ä¸²ï¼šeyJmb28iOiJiYXIiLCJpYXQiOjE1ODc1NDgyMTV9
```

### signature

è¿™ä¸€éƒ¨åˆ†æ˜¯jwtçš„ç­¾åï¼Œæ­£æ˜¯å®ƒçš„å­˜åœ¨ï¼Œä¿è¯äº†æ•´ä¸ªjwtä¸è¢«ç¯¡æ”¹

è¿™éƒ¨åˆ†çš„ç”Ÿæˆï¼Œæ˜¯å¯¹å‰é¢ä¸¤ä¸ªéƒ¨åˆ†çš„ç¼–ç ç»“æœï¼ŒæŒ‰ç…§å¤´éƒ¨æŒ‡å®šçš„æ–¹å¼è¿›è¡ŒåŠ å¯†

æ¯”å¦‚ï¼šå¤´éƒ¨æŒ‡å®šçš„åŠ å¯†æ–¹æ³•æ˜¯`HS256`ï¼Œå‰é¢ä¸¤éƒ¨åˆ†çš„ç¼–ç ç»“æœæ˜¯`eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmb28iOiJiYXIiLCJpYXQiOjE1ODc1NDgyMTV9`

åˆ™ç¬¬ä¸‰éƒ¨åˆ†å°±æ˜¯ç”¨å¯¹ç§°åŠ å¯†ç®—æ³•`HS256`å¯¹å­—ç¬¦ä¸²`eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmb28iOiJiYXIiLCJpYXQiOjE1ODc1NDgyMTV9`è¿›è¡ŒåŠ å¯†ï¼Œå½“ç„¶ä½ å¾—æŒ‡å®šä¸€ä¸ªç§˜é’¥ï¼Œæ¯”å¦‚`shhhhh`

```js
HS256(`eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmb28iOiJiYXIiLCJpYXQiOjE1ODc1NDgyMTV9`, "shhhhh")
// å¾—åˆ°ï¼šBCwUy3jnUQ_E6TqCayc7rCHkx-vxxdagUwPOWqwYCFc
```

æœ€ç»ˆï¼Œå°†ä¸‰éƒ¨åˆ†ç»„åˆåœ¨ä¸€èµ·ï¼Œå°±å¾—åˆ°äº†å®Œæ•´çš„jwt

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmb28iOiJiYXIiLCJpYXQiOjE1ODc1NDgyMTV9.BCwUy3jnUQ_E6TqCayc7rCHkx-vxxdagUwPOWqwYCFc
```

ç”±äºç­¾åä½¿ç”¨çš„ç§˜é’¥ä¿å­˜åœ¨æœåŠ¡å™¨ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå®¢æˆ·ç«¯å°±æ— æ³•ä¼ªé€ å‡ºç­¾åï¼Œå› ä¸ºå®ƒæ‹¿ä¸åˆ°ç§˜é’¥ã€‚

æ¢å¥è¯è¯´ï¼Œä¹‹æ‰€ä»¥è¯´æ— æ³•ä¼ªé€ jwtï¼Œå°±æ˜¯å› ä¸ºç¬¬ä¸‰éƒ¨åˆ†çš„å­˜åœ¨ã€‚

è€Œå‰é¢ä¸¤éƒ¨åˆ†å¹¶æ²¡æœ‰åŠ å¯†ï¼Œåªæ˜¯ä¸€ä¸ªç¼–ç ç»“æœè€Œå·²ï¼Œå¯ä»¥è®¤ä¸ºå‡ ä¹æ˜¯æ˜æ–‡ä¼ è¾“

> è¿™ä¸ä¼šé€ æˆå¤ªå¤§çš„é—®é¢˜ï¼Œå› ä¸ºæ—¢ç„¶ç”¨æˆ·ç™»é™†æˆåŠŸäº†ï¼Œå®ƒå½“ç„¶æœ‰æƒåŠ›æŸ¥çœ‹è‡ªå·±çš„ç”¨æˆ·ä¿¡æ¯
>
> ç”šè‡³åœ¨æŸäº›ç½‘ç«™ï¼Œç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯å¯ä»¥è¢«ä»»ä½•äººæŸ¥çœ‹
>
> ä½ è¦ä¿è¯çš„ï¼Œæ˜¯ä¸è¦æŠŠæ•æ„Ÿçš„ä¿¡æ¯å­˜æ”¾åˆ°jwtä¸­ï¼Œæ¯”å¦‚å¯†ç 

jwtçš„`signature`å¯ä»¥ä¿è¯ä»¤ç‰Œä¸è¢«ä¼ªé€ ï¼Œé‚£å¦‚ä½•ä¿è¯ä»¤ç‰Œä¸è¢«ç¯¡æ”¹å‘¢ï¼Ÿ

æ¯”å¦‚ï¼ŒæŸä¸ªç”¨æˆ·ç™»é™†æˆåŠŸäº†ï¼Œè·å¾—äº†jwtï¼Œä½†ä»–äººä¸ºçš„ç¯¡æ”¹äº†`payload`ï¼Œæ¯”å¦‚æŠŠè‡ªå·±çš„è´¦æˆ·ä½™é¢ä¿®æ”¹ä¸ºåŸæ¥çš„ä¸¤å€ï¼Œç„¶åé‡æ–°ç¼–ç å‡º`payload`å‘é€åˆ°æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å¦‚ä½•å¾—çŸ¥è¿™äº›ä¿¡æ¯è¢«ç¯¡æ”¹è¿‡äº†å‘¢ï¼Ÿ

è¿™å°±è¦è¯´åˆ°ä»¤ç‰Œçš„éªŒè¯äº†

### ä»¤ç‰Œçš„éªŒè¯

![image-20200422172837190](assets/jwt4.png)

ä»¤ç‰Œåœ¨æœåŠ¡å™¨ç»„è£…å®Œæˆåï¼Œä¼šä»¥ä»»æ„çš„æ–¹å¼å‘é€åˆ°å®¢æˆ·ç«¯

å®¢æˆ·ç«¯ä¼šæŠŠä»¤ç‰Œä¿å­˜èµ·æ¥ï¼Œåç»­çš„è¯·æ±‚ä¼šå°†ä»¤ç‰Œå‘é€ç»™æœåŠ¡å™¨

è€ŒæœåŠ¡å™¨éœ€è¦éªŒè¯ä»¤ç‰Œæ˜¯å¦æ­£ç¡®ï¼Œå¦‚ä½•éªŒè¯å‘¢ï¼Ÿ

é¦–å…ˆï¼ŒæœåŠ¡å™¨è¦éªŒè¯è¿™ä¸ªä»¤ç‰Œæ˜¯å¦è¢«ç¯¡æ”¹è¿‡ï¼ŒéªŒè¯æ–¹å¼éå¸¸ç®€å•ï¼Œå°±æ˜¯å¯¹`header+payload`ç”¨åŒæ ·çš„ç§˜é’¥å’ŒåŠ å¯†ç®—æ³•è¿›è¡Œé‡æ–°åŠ å¯†

ç„¶åæŠŠåŠ å¯†çš„ç»“æœå’Œä¼ å…¥jwtçš„`signature`è¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœå®Œå…¨ç›¸åŒï¼Œåˆ™è¡¨ç¤ºå‰é¢ä¸¤éƒ¨åˆ†æ²¡æœ‰åŠ¨è¿‡ï¼Œå°±æ˜¯è‡ªå·±é¢å‘çš„ï¼Œå¦‚æœä¸åŒï¼Œè‚¯å®šæ˜¯è¢«ç¯¡æ”¹è¿‡äº†ã€‚

```
ä¼ å…¥çš„header.ä¼ å…¥çš„payload.ä¼ å…¥çš„signature
æ–°çš„signature = headerä¸­çš„åŠ å¯†ç®—æ³•(ä¼ å…¥çš„header.ä¼ å…¥çš„payload, ç§˜é’¥)
éªŒè¯ï¼šæ–°çš„signature == ä¼ å…¥çš„signature
```

å½“ä»¤ç‰ŒéªŒè¯ä¸ºæ²¡æœ‰è¢«ç¯¡æ”¹åï¼ŒæœåŠ¡å™¨å¯ä»¥è¿›è¡Œå…¶ä»–éªŒè¯ï¼šæ¯”å¦‚æ˜¯å¦è¿‡æœŸã€å¬ä¼—æ˜¯å¦æ»¡è¶³è¦æ±‚ç­‰ç­‰ï¼Œè¿™äº›å°±è§†æƒ…å†µè€Œå®šäº†

æ³¨æ„ï¼šè¿™äº›éªŒè¯éƒ½éœ€è¦æœåŠ¡å™¨æ‰‹åŠ¨å®Œæˆï¼Œæ²¡æœ‰å“ªä¸ªæœåŠ¡å™¨ä¼šç»™ä½ è¿›è¡Œè‡ªåŠ¨éªŒè¯ï¼Œå½“ç„¶ï¼Œä½ å¯ä»¥å€ŸåŠ©ç¬¬ä¸‰æ–¹åº“æ¥å®Œæˆè¿™äº›æ“ä½œ

### æ€»ç»“

æœ€åï¼Œæ€»ç»“ä¸€ä¸‹jwtçš„ç‰¹ç‚¹ï¼š

- jwtæœ¬è´¨ä¸Šæ˜¯ä¸€ç§ä»¤ç‰Œæ ¼å¼ã€‚å®ƒå’Œç»ˆç«¯è®¾å¤‡æ— å…³ï¼ŒåŒæ ·å’ŒæœåŠ¡å™¨æ— å…³ï¼Œç”šè‡³ä¸å¦‚ä½•ä¼ è¾“æ— å…³ï¼Œå®ƒåªæ˜¯è§„èŒƒäº†ä»¤ç‰Œçš„æ ¼å¼è€Œå·²
- jwtç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šheaderã€payloadã€signatureã€‚ä¸»ä½“ä¿¡æ¯åœ¨payload
- jwtéš¾ä»¥è¢«ç¯¡æ”¹å’Œä¼ªé€ ã€‚è¿™æ˜¯å› ä¸ºæœ‰ç¬¬ä¸‰éƒ¨åˆ†çš„ç­¾åå­˜åœ¨ã€‚


## ç™»å½•å’Œè®¤è¯-æœåŠ¡å™¨å¼€å‘

#### jsonwebtokenåº“
```js
const jwt = require('jsonwebtoken')
const secrect = "ä½™æ¦†";
const token = jwt.sign(
    {
        id: 1,
        name: "æˆå“¥",
    },
    secrect,
    {
        expiresIn: 3600
    });


// åªæ˜¯è§£å¯†ä¸éªŒè¯
jwt.decode(token)

// è§£å¯†+éªŒè¯
jwt.verify(token, secrect)

```

#### é¢å‘jwt

- ç¡®å®šè¿‡æœŸæ—¶é—´
- ç¡®å®šä¸»ä½“
- ç¡®å®šå¯†é’¥
- ç¡®å®šä¼ è¾“æ–¹å¼
  - cookie (req.cookies.token)
  - authorization  (req.headers.authorization)
    - å¸¦bearer
    - ä¸å¸¦bearer

```js
const secrect = "yuyu"; //å¯†é’¥
const cookieKey = "token"
const jwt =require("jsonwebtoken")
// é¢å‘jwt
exports.publish = function (res, maxAge = 3600 * 24, info={}){
    const token = jwt.sign(info, secrect, {
        expiresIn: maxAge
    });
    // æ·»åŠ åˆ°cookie åŸç”Ÿå°±æœ‰
    res.cookie(cookieKey, token, {
        maxAge: maxAge * 1000,
        path:"/"
    })

    // æ·»åŠ å…¶ä»–ä¼ è¾“
    res.header('authorization', token)
}

```


#### è®¤è¯jwt

```js
// è®¤è¯jwt


exports.verify = function (req){
    let token;
    // å…ˆå°è¯•ä»cookieä¸­è·å–
    token = req.cookies[cookieKey];

    // cookieæ²¡æœ‰
    if(!token){
        // å°è¯•ä»headerä¸­è·å–
        token = req.headers.authorization
        if(!token){
            // è¿˜æ˜¯æ²¡æœ‰token
            return null
        }
        token = token.split(" ");
        token = token.length === 1 ? token[0] : token [1];
    }
    try{
        return jwt.verify(token, secrect)
    }catch {
        return  null
    }
}
```

#### æ·»åŠ whoamiæ¥å£



## ç™»å½•å’Œè®¤è¯-å®¢æˆ·ç«¯å¼€å‘

å°è£…axios
```js
// 1ã€å‘é€è¯·æ±‚çš„æ—¶å€™ï¼Œå¦‚æœæœ‰tokenï¼Œéœ€è¦é™„å¸¦åˆ°è¯·æ±‚å¤´ä¸­
// 2ã€å“åº”çš„æ—¶å€™ï¼Œå¦‚æœæœ‰token,ä¿å­˜tokenåˆ°æœ¬åœ°ï¼ˆlocalstorageï¼‰
// 3ã€å“åº”çš„æ—¶å€™ï¼Œå¦‚æœå“åº”çš„æ¶ˆæ¯ç æ˜¯403ï¼ˆæ²¡æœ‰tokenï¼Œtokenå¤±æ•ˆï¼‰æœ¬åœ°åˆ é™¤token


import axios from 'axios'
export default function (){
    // 1ã€
    const token = localStorage.getItem("token");
    let instance = axios;
    if(token){
        instance = axios.create({
            headers:{
                authorization: "bearer " + token;
            }
        })
    }

    instance.interceptors.response.use(resp=>{
        // 2ã€
        if(resp.headers.authorization){
            localStorage.setItem("token", resp.headers.authorization);
        }
        return resp
    }, error => {
        // 3ã€
        if(error.response.status === 403){
            localStorage.removeItem('token');
        }
        return Promise.reject(error)
    })
    return instance
}
```

